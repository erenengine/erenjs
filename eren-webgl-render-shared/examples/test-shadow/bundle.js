(()=>{"use strict";const e=WebGL2RenderingContext.ARRAY_BUFFER,t=WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,r=WebGL2RenderingContext.STATIC_DRAW,o=WebGL2RenderingContext.FLOAT,i=WebGL2RenderingContext.LESS;function n(e,t,r){const i=e.createVertexArray(function(e){const t=new Float32Array(6*e.length);for(let r=0;r<e.length;r++){const o=6*r;t.set(e[r].position,o+0),t.set(e[r].normal,o+3)}return t}(t),new Uint16Array(r));return e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,o,!1,24,0),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,o,!1,24,12),{vao:i,indexCount:r.length}}var a=1e-6,s="undefined"!=typeof Float32Array?Float32Array:Array;function h(){var e=new s(3);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function l(e,t,r){var o=new s(3);return o[0]=e,o[1]=t,o[2]=r,o}function d(){var e=new s(16);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),h();function c(e,t,r,o){var i,n,s,h,l,d,c,u,g,f,m=t[0],w=t[1],T=t[2],E=o[0],x=o[1],p=o[2],P=r[0],b=r[1],v=r[2];return Math.abs(m-P)<a&&Math.abs(w-b)<a&&Math.abs(T-v)<a?function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}(e):(c=m-P,u=w-b,g=T-v,i=x*(g*=f=1/Math.hypot(c,u,g))-p*(u*=f),n=p*(c*=f)-E*g,s=E*u-x*c,(f=Math.hypot(i,n,s))?(i*=f=1/f,n*=f,s*=f):(i=0,n=0,s=0),h=u*s-g*n,l=g*i-c*s,d=c*n-u*i,(f=Math.hypot(h,l,d))?(h*=f=1/f,l*=f,d*=f):(h=0,l=0,d=0),e[0]=i,e[1]=h,e[2]=c,e[3]=0,e[4]=n,e[5]=l,e[6]=u,e[7]=0,e[8]=s,e[9]=d,e[10]=g,e[11]=0,e[12]=-(i*m+n*w+s*T),e[13]=-(h*m+l*w+d*T),e[14]=-(c*m+u*w+g*T),e[15]=1,e)}class u{#e;#t;constructor(e,t,r){this.#e=e,this.#t=this.#e.createProgram(t,r)}use(){this.#e.useProgram(this.#t)}getUniformLocation(e){const t=this.#e.getUniformLocation(this.#t,e);if(!t)throw new Error(`Failed to get uniform location (${e})`);return t}}const g={r:.1921,g:.302,b:.4745,a:1};class f{#e;#t;#r;#o;constructor(e,t){this.#e=e,this.#t=new u(e,"#version 300 es\n\nout vec2 fragUV;\n\nconst vec2 positions[3] = vec2[](\n    vec2(-1.0, -1.0),\n    vec2(-1.0,  3.0),\n    vec2( 3.0, -1.0)\n);\n\nconst vec2 uvs[3] = vec2[](\n    vec2(0.0, 0.0),\n    vec2(0.0, 2.0),\n    vec2(2.0, 0.0)\n);\n\nvoid main() {\n    gl_Position = vec4(positions[gl_VertexID], 0.0, 1.0);\n    fragUV = uvs[gl_VertexID];\n}\n","#version 300 es\nprecision highp float;\n\nin vec2 fragUV;\n\nout vec4 outColor;\n\nuniform sampler2D shadowMap;\n\nvoid main() {\n    float depth = texture(shadowMap, fragUV).r;\n    outColor = vec4(vec3(depth), 1.0); // 흑백 시각화\n}\n"),this.#r=t;const r=this.#t.getUniformLocation("shadowMap");if(!r)throw new Error("Failed to get uniform location (shadowMap)");this.#o=r}rebindShadowTexture(e){this.#r=e}recordCommands(){this.#e.clearColor(g),this.#t.use(),this.#e.bindRawDepthTexture(this.#r,this.#o),this.#e.draw(3,1)}}class m{shadowTexture;#e;#t;#i;#n;#a;constructor(e,t,r){this.#e=e,this.#t=new u(e,"#version 300 es\n\nin vec3 inPosition;\nin vec3 inNormal;\n\nuniform mat4 uLightViewProj;\n\nvoid main() {\n    gl_Position = uLightViewProj * vec4(inPosition, 1.0);\n}\n"),this.#i=this.#t.getUniformLocation("uLightViewProj"),e.enableDepthTest(),e.depthFunc(i),this.shadowTexture=e.createDepthTexture(t,r),this.#n=e.createDepthFramebuffer(this.shadowTexture)}resizeShadowTexture(e,t){const r=this.#e;r.deleteTexture(this.shadowTexture),r.deleteFramebuffer(this.#n),this.shadowTexture=r.createDepthTexture(e,t),this.#n=r.createDepthFramebuffer(this.shadowTexture)}updateShadowUBO(e){this.#a=e}recordCommands(e){const t=this.#e;t.bindDepthFramebuffer(this.#n),t.clearDepth(1),this.#t.use(),this.#a&&t.uniformMatrix4fv(this.#i,!1,this.#a.lightViewProj);for(const r of e)t.bindVertexArray(r.vao),t.drawElements(r.indexCount);t.restoreFramebufferDefaultState()}}const w={r:.1921,g:.302,b:.4745,a:1};class T{#e;#t;#r;#s;#h;#l;#i;#d;#c;#o;#u;#g;constructor(e,t){this.#e=e,this.#r=t,this.#t=new u(e,"#version 300 es\n\nin vec3 inPosition;\nin vec3 inNormal;\n\nout vec3 fragPosWorld;\nout vec3 normalWorld;\nout vec4 shadowCoord;\n\nuniform mat4 uModel;\nuniform mat4 uView;\nuniform mat4 uProj;\nuniform mat4 uLightViewProj;\n\nvoid main() {\n    vec4 worldPos = uModel * vec4(inPosition, 1.0);\n\n    fragPosWorld = worldPos.xyz;\n    normalWorld = mat3(transpose(inverse(uModel))) * inNormal;\n    shadowCoord = uLightViewProj * worldPos;\n\n    gl_Position = uProj * uView * worldPos;\n}\n","#version 300 es\nprecision highp float;\n\nin vec3 fragPosWorld;\nin vec3 normalWorld;\nin vec4 shadowCoord;\n\nout vec4 outColor;\n\nuniform sampler2D shadowMap;\n\nuniform vec3 uLightDirection;  // 단위벡터\nuniform vec3 uLightColor;      // 빛 색상\n\nfloat calculateShadow(vec4 shadowCoord) {\n    vec3 projCoords = shadowCoord.xyz / shadowCoord.w;\n\n    // X, Y [-1,1] → [0,1]\n    vec2 shadowTexCoord = projCoords.xy * 0.5 + 0.5;\n    float currentDepth = projCoords.z * 0.5 + 0.5;\n\n    // 범위 밖이면 그림자 없음\n    if (currentDepth > 1.0 || shadowTexCoord.x < 0.0 || shadowTexCoord.x > 1.0 ||\n        shadowTexCoord.y < 0.0 || shadowTexCoord.y > 1.0) {\n        return 0.0;\n    }\n\n    float bias = max(0.005 * (1.0 - dot(normalize(normalWorld), normalize(-uLightDirection))), 0.0005);\n\n    float shadow = 0.0;\n    float texelSize = 1.0 / 2048.0;\n\n    for (int x = -1; x <= 1; ++x) {\n        for (int y = -1; y <= 1; ++y) {\n            vec2 offset = vec2(x, y) * texelSize;\n            float closestDepth = texture(shadowMap, shadowTexCoord + offset).r;\n            shadow += (currentDepth - bias > closestDepth) ? 1.0 : 0.0;\n        }\n    }\n\n    shadow /= 9.0;\n\n    return shadow;\n}\n\nvoid main() {\n    vec3 norm = normalize(normalWorld);\n    vec3 lightDir = normalize(-uLightDirection);\n\n    float ambientStrength = 0.1;\n    vec3 ambient = ambientStrength * uLightColor;\n\n    float diff = max(dot(norm, lightDir), 0.0);\n    vec3 diffuse = uLightColor * diff;\n\n    float shadow = calculateShadow(shadowCoord);\n\n    vec3 baseColor;\n    if (fragPosWorld.y == -1.0) {\n        baseColor = vec3(0.8, 0.8, 0.8); // 땅\n    } else {\n        baseColor = vec3(1.0, 0.7, 0.2); // 큐브\n    }\n\n    vec3 lighting = ambient + (1.0 - shadow) * diffuse;\n\n    outColor = vec4(baseColor * lighting, 1.0);\n}\n"),this.#s=this.#t.getUniformLocation("uModel"),this.#h=this.#t.getUniformLocation("uView"),this.#l=this.#t.getUniformLocation("uProj"),this.#i=this.#t.getUniformLocation("uLightViewProj"),this.#d=this.#t.getUniformLocation("uLightDirection"),this.#c=this.#t.getUniformLocation("uLightColor"),this.#o=this.#t.getUniformLocation("shadowMap"),e.enableDepthTest(),e.depthFunc(i)}rebindShadowTexture(e){this.#r=e}updateMainUBO(e){this.#u=e}updateLightUBO(e){this.#g=e}recordCommands(e){const t=this.#e;t.clearColor(w),t.clearDepth(1),this.#t.use(),this.#u&&(t.uniformMatrix4fv(this.#s,!1,this.#u.model),t.uniformMatrix4fv(this.#h,!1,this.#u.view),t.uniformMatrix4fv(this.#l,!1,this.#u.proj),t.uniformMatrix4fv(this.#i,!1,this.#u.lightViewProj)),this.#g&&(t.uniform3fv(this.#d,this.#g.direction),t.uniform3fv(this.#c,this.#g.color)),t.bindRawDepthTexture(this.#r,this.#o);for(const r of e)t.bindVertexArray(r.vao),t.drawElements(r.indexCount)}}const E=document.getElementById("canvas"),x=new class{#e;constructor(e){this.#e=e}#f(e,t){const r=this.#e.createShader(t);if(!r)throw new Error("Failed to create shader");if(this.#e.shaderSource(r,e),this.#e.compileShader(r),!this.#e.getShaderParameter(r,this.#e.COMPILE_STATUS)){const e=this.#e.getShaderInfoLog(r);throw this.#e.deleteShader(r),new Error("Failed to compile shader: "+e)}return r}createProgram(e,t){const r=this.#f(e,this.#e.VERTEX_SHADER),o=this.#f(t??"#version 300 es\nprecision mediump float;\nvoid main() { }",this.#e.FRAGMENT_SHADER),i=this.#e.createProgram();if(this.#e.attachShader(i,r),o&&this.#e.attachShader(i,o),this.#e.linkProgram(i),!this.#e.getProgramParameter(i,this.#e.LINK_STATUS)){const e=this.#e.getProgramInfoLog(i);throw this.#e.deleteProgram(i),new Error("Failed to link program: "+e)}return i}useProgram(e){this.#e.useProgram(e)}createVertexArray(o,i){const n=this.#e.createVertexArray();this.#e.bindVertexArray(n);const a=this.#e.createBuffer();if(this.#e.bindBuffer(e,a),this.#e.bufferData(e,o,r),i){const e=this.#e.createBuffer();this.#e.bindBuffer(t,e),this.#e.bufferData(t,i,r)}return n}bindVertexArray(e){this.#e.bindVertexArray(e)}createBuffer(){return this.#e.createBuffer()}bindBuffer(e,t){this.#e.bindBuffer(e,t)}bufferData(e,t,r){this.#e.bufferData(e,t,r)}enableVertexAttribArray(e){this.#e.enableVertexAttribArray(e)}vertexAttribPointer(e,t,r,o,i,n){this.#e.vertexAttribPointer(e,t,r,o,i,n)}uniformMatrix4fv(e,t,r){this.#e.uniformMatrix4fv(e,t,r)}uniform3fv(e,t){this.#e.uniform3fv(e,t)}getUniformLocation(e,t){return this.#e.getUniformLocation(e,t)}clearColor(e){this.#e.clearColor(e.r,e.g,e.b,e.a),this.#e.clear(this.#e.COLOR_BUFFER_BIT)}draw(e,t){this.#e.drawArraysInstanced(this.#e.TRIANGLES,0,e,t)}drawElements(e){this.#e.drawElements(this.#e.TRIANGLES,e,this.#e.UNSIGNED_SHORT,0)}drawIndexed(e,t){this.#e.drawElementsInstanced(this.#e.TRIANGLE_STRIP,e,this.#e.UNSIGNED_SHORT,0,t)}enableDepthTest(){this.#e.enable(this.#e.DEPTH_TEST)}disableDepthTest(){this.#e.disable(this.#e.DEPTH_TEST)}depthFunc(e){this.#e.depthFunc(e)}clearDepth(e){this.#e.clearDepth(e),this.#e.clear(this.#e.DEPTH_BUFFER_BIT)}createDepthTexture(e,t){const r=this.#e,o=r.createTexture();if(!o)throw new Error("Failed to create depth texture");return r.bindTexture(r.TEXTURE_2D,o),r.texImage2D(r.TEXTURE_2D,0,r.DEPTH_COMPONENT24,e,t,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.COMPARE_REF_TO_TEXTURE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_FUNC,r.LESS),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.bindTexture(r.TEXTURE_2D,null),o}createDepthFramebuffer(e){const t=this.#e,r=t.createFramebuffer();if(!r)throw new Error("Failed to create shadow framebuffer");t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,e,0),t.drawBuffers([t.NONE]),t.readBuffer(t.NONE);const o=t.checkFramebufferStatus(t.FRAMEBUFFER);if(o!==t.FRAMEBUFFER_COMPLETE)throw new Error(`Incomplete shadow framebuffer: 0x${o.toString(16)}`);return t.bindFramebuffer(t.FRAMEBUFFER,null),r}bindDepthFramebuffer(e){this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,e),this.#e.colorMask(!1,!1,!1,!1)}restoreFramebufferDefaultState(){this.#e.bindVertexArray(null),this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,null),this.#e.colorMask(!0,!0,!0,!0)}deleteTexture(e){this.#e.deleteTexture(e)}deleteFramebuffer(e){this.#e.deleteFramebuffer(e)}bindRawDepthTexture(e,t){const r=this.#e;r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,r.NONE),r.uniform1i(t,0)}}(E.getContext("webgl2")),p=new class{#m;#w;#T;#E;constructor(e,t,r){this.#m=new m(e,t,r),this.#w=new f(e,this.#m.shadowTexture),this.#T=new T(e,this.#m.shadowTexture),this.#E=performance.now()}resize(e,t){this.#m.resizeShadowTexture(e,t),this.#w.rebindShadowTexture(this.#m.shadowTexture),this.#T.rebindShadowTexture(this.#m.shadowTexture)}render(e,t,r){const o=(performance.now()-this.#E)/1e3,i=l(8*Math.cos(.4*o),6,-8*Math.sin(.4*o)),n=d();var a,s,u,g,f,m,w,T,E,x;T=1/((s=-10)-(u=10)),E=1/((g=-10)-(f=10)),x=1/((m=-10)-(w=20)),(a=n)[0]=-2*T,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*E,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*x,a[11]=0,a[12]=(s+u)*T,a[13]=(f+g)*E,a[14]=(w+m)*x,a[15]=1;const p=d();c(p,i,l(0,0,0),l(0,1,0));const P=d();(function(e,t,r){var o=t[0],i=t[1],n=t[2],a=t[3],s=t[4],h=t[5],l=t[6],d=t[7],c=t[8],u=t[9],g=t[10],f=t[11],m=t[12],w=t[13],T=t[14],E=t[15],x=r[0],p=r[1],P=r[2],b=r[3];e[0]=x*o+p*s+P*c+b*m,e[1]=x*i+p*h+P*u+b*w,e[2]=x*n+p*l+P*g+b*T,e[3]=x*a+p*d+P*f+b*E,x=r[4],p=r[5],P=r[6],b=r[7],e[4]=x*o+p*s+P*c+b*m,e[5]=x*i+p*h+P*u+b*w,e[6]=x*n+p*l+P*g+b*T,e[7]=x*a+p*d+P*f+b*E,x=r[8],p=r[9],P=r[10],b=r[11],e[8]=x*o+p*s+P*c+b*m,e[9]=x*i+p*h+P*u+b*w,e[10]=x*n+p*l+P*g+b*T,e[11]=x*a+p*d+P*f+b*E,x=r[12],p=r[13],P=r[14],b=r[15],e[12]=x*o+p*s+P*c+b*m,e[13]=x*i+p*h+P*u+b*w,e[14]=x*n+p*l+P*g+b*T,e[15]=x*a+p*d+P*f+b*E})(P,n,p),this.#m.updateShadowUBO({lightViewProj:P}),this.#m.recordCommands(e);{const n=l(8*Math.cos(-.2*o),6,8*Math.sin(-.2*o)),a=d();c(a,n,l(0,0,0),l(0,1,0));const s=d();!function(e,t,r,o,i){var n,a=1/Math.tan(t/2);e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(n=1/(o-i),e[10]=(i+o)*n,e[14]=2*i*o*n):(e[10]=-1,e[14]=-2*o)}(s,45*Math.PI/180,t/r,.1,100);const u={model:d(),view:a,proj:s,lightViewProj:P};this.#T.updateMainUBO(u);const g=h();(function(e,t,r){e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2]})(g,l(0,0,0),i),function(e,t){var r=t[0],o=t[1],i=t[2],n=r*r+o*o+i*i;n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n}(g,g);const f={direction:g,color:l(1,1,1)};this.#T.updateLightUBO(f),this.#T.recordCommands(e)}}}(x,E.width,E.height),P=function(){const e=l(0,1,0);return{vertices:[l(-5,-1,-5),l(5,-1,-5),l(5,-1,5),l(-5,-1,5)].map((t=>({position:t,normal:e}))),indices:[0,2,1,2,0,3]}}(),b={vertices:[[l(-.5,-.5,.5),l(0,0,1)],[l(.5,-.5,.5),l(0,0,1)],[l(.5,.5,.5),l(0,0,1)],[l(-.5,.5,.5),l(0,0,1)],[l(.5,-.5,-.5),l(0,0,-1)],[l(-.5,-.5,-.5),l(0,0,-1)],[l(-.5,.5,-.5),l(0,0,-1)],[l(.5,.5,-.5),l(0,0,-1)],[l(-.5,.5,.5),l(0,1,0)],[l(.5,.5,.5),l(0,1,0)],[l(.5,.5,-.5),l(0,1,0)],[l(-.5,.5,-.5),l(0,1,0)],[l(-.5,-.5,-.5),l(0,-1,0)],[l(.5,-.5,-.5),l(0,-1,0)],[l(.5,-.5,.5),l(0,-1,0)],[l(-.5,-.5,.5),l(0,-1,0)],[l(.5,-.5,.5),l(1,0,0)],[l(.5,-.5,-.5),l(1,0,0)],[l(.5,.5,-.5),l(1,0,0)],[l(.5,.5,.5),l(1,0,0)],[l(-.5,-.5,-.5),l(-1,0,0)],[l(-.5,-.5,.5),l(-1,0,0)],[l(-.5,.5,.5),l(-1,0,0)],[l(-.5,.5,-.5),l(-1,0,0)]].map((e=>({position:e[0],normal:e[1]}))),indices:[0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8,12,13,14,14,15,12,16,17,18,18,19,16,20,21,22,22,23,20]},v=[n(x,P.vertices,P.indices),n(x,b.vertices,b.indices)];!function e(){p.render(v,E.width,E.height),requestAnimationFrame(e)}()})();