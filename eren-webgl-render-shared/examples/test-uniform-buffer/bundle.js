(()=>{"use strict";const e=WebGL2RenderingContext.ARRAY_BUFFER,r=WebGL2RenderingContext.ELEMENT_ARRAY_BUFFER,t=WebGL2RenderingContext.STATIC_DRAW,o=WebGL2RenderingContext.FLOAT;WebGL2RenderingContext.LESS;class i{#e;#r;constructor(e,r,t){this.#e=e,this.#r=this.#e.createProgram(r,t)}use(){this.#e.useProgram(this.#r)}getUniformLocation(e){return this.#e.getUniformLocation(this.#r,e)}}var a,n=1e-6,s="undefined"!=typeof Float32Array?Float32Array:Array;function l(e,r){var t=new s(2);return t[0]=e,t[1]=r,t}function h(e,r,t){var o=new s(3);return o[0]=e,o[1]=r,o[2]=t,o}function E(){var e=new s(16);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,r=arguments.length;r--;)e+=arguments[r]*arguments[r];return Math.sqrt(e)}),a=new s(2),s!=Float32Array&&(a[0]=0,a[1]=0),function(){var e=new s(3);s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0)}();const g={r:.1921,g:.302,b:.4745,a:1},u=[{pos:l(-.5,-.5),color:h(1,0,0)},{pos:l(.5,-.5),color:h(0,1,0)},{pos:l(.5,.5),color:h(0,0,1)},{pos:l(-.5,.5),color:h(1,1,1)}],c=[0,1,2,2,3,0];class f{#e;#r;#t;#o;#i;#a;#n;constructor(e){this.#e=e,this.#r=new i(e,"#version 300 es\nprecision mediump float;\n\nuniform mat4 uModel;\nuniform mat4 uView;\nuniform mat4 uProj;\n\nin vec2 aPosition;\nin vec3 aColor;\n\nout vec3 vColor;\n\nvoid main() {\n    gl_Position = uProj * uView * uModel * vec4(aPosition, 0.0, 1.0);\n    vColor = aColor;\n}\n","#version 300 es\nprecision mediump float;\n\nin  vec3 vColor;\nout vec4 outColor;\n\nvoid main() {\n    outColor = vec4(vColor, 1.0);\n}\n"),this.#t=e.createVertexArray(function(e){const r=new Float32Array(5*e.length);for(let t=0;t<e.length;t++){const o=5*t;r.set(e[t].pos,o+0),r.set(e[t].color,o+2)}return r}(u),new Uint16Array(c)),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,2,o,!1,20,0),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,o,!1,20,8);const r=this.#r.getUniformLocation("uModel"),t=this.#r.getUniformLocation("uView"),a=this.#r.getUniformLocation("uProj");if(!r)throw new Error("Failed to get uniform location (uModel)");if(!t)throw new Error("Failed to get uniform location (uView)");if(!a)throw new Error("Failed to get uniform location (uProj)");this.#o=r,this.#i=t,this.#a=a,this.#n=Date.now()}#s(e,r){const t=(performance.now()-this.#n)/1e3,o={model:E(),view:E(),proj:E()};!function(e,r){var t=Math.sin(r),o=Math.cos(r);e[0]=o,e[1]=t,e[2]=0,e[3]=0,e[4]=-t,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(o.model,-90*t*Math.PI/180);const i=h(2,2,2),a=h(0,0,0),s=h(0,0,1);!function(e,r,t,o){var i,a,s,l,h,E,g,u,c,f,T=r[0],d=r[1],m=r[2],R=o[0],A=o[1],b=o[2],F=t[0],_=t[1],P=t[2];Math.abs(T-F)<n&&Math.abs(d-_)<n&&Math.abs(m-P)<n?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(g=T-F,u=d-_,c=m-P,i=A*(c*=f=1/Math.hypot(g,u,c))-b*(u*=f),a=b*(g*=f)-R*c,s=R*u-A*g,(f=Math.hypot(i,a,s))?(i*=f=1/f,a*=f,s*=f):(i=0,a=0,s=0),l=u*s-c*a,h=c*i-g*s,E=g*a-u*i,(f=Math.hypot(l,h,E))?(l*=f=1/f,h*=f,E*=f):(l=0,h=0,E=0),e[0]=i,e[1]=l,e[2]=g,e[3]=0,e[4]=a,e[5]=h,e[6]=u,e[7]=0,e[8]=s,e[9]=E,e[10]=c,e[11]=0,e[12]=-(i*T+a*d+s*m),e[13]=-(l*T+h*d+E*m),e[14]=-(g*T+u*d+c*m),e[15]=1)}(o.view,i,a,s);const l=e/r;return function(e,r,t,o,i){var a,n=1/Math.tan(r/2);e[0]=n/t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(a=1/(o-i),e[10]=(i+o)*a,e[14]=2*i*o*a):(e[10]=-1,e[14]=-2*o)}(o.proj,Math.PI/4,l,.1,10),o}recordCommands(e,r){this.#e.clearColor(g),this.#r.use(),this.#e.bindVertexArray(this.#t);const t=this.#s(e,r);this.#e.uniformMatrix4fv(this.#o,!1,t.model),this.#e.uniformMatrix4fv(this.#i,!1,t.view),this.#e.uniformMatrix4fv(this.#a,!1,t.proj),this.#e.drawIndexed(c.length,1)}}const T=document.getElementById("canvas"),d=new class{#e;constructor(e){this.#e=e}#l(e,r){const t=this.#e.createShader(r);if(!t)throw new Error("Failed to create shader");if(this.#e.shaderSource(t,e),this.#e.compileShader(t),!this.#e.getShaderParameter(t,this.#e.COMPILE_STATUS)){const e=this.#e.getShaderInfoLog(t);throw this.#e.deleteShader(t),new Error("Failed to compile shader: "+e)}return t}createProgram(e,r){const t=this.#l(e,this.#e.VERTEX_SHADER),o=this.#l(r??"#version 300 es\nprecision mediump float;\nvoid main() { }",this.#e.FRAGMENT_SHADER),i=this.#e.createProgram();if(this.#e.attachShader(i,t),o&&this.#e.attachShader(i,o),this.#e.linkProgram(i),!this.#e.getProgramParameter(i,this.#e.LINK_STATUS)){const e=this.#e.getProgramInfoLog(i);throw this.#e.deleteProgram(i),new Error("Failed to link program: "+e)}return i}useProgram(e){this.#e.useProgram(e)}createVertexArray(o,i){const a=this.#e.createVertexArray();this.#e.bindVertexArray(a);const n=this.#e.createBuffer();if(this.#e.bindBuffer(e,n),this.#e.bufferData(e,o,t),i){const e=this.#e.createBuffer();this.#e.bindBuffer(r,e),this.#e.bufferData(r,i,t)}return a}bindVertexArray(e){this.#e.bindVertexArray(e)}createBuffer(){return this.#e.createBuffer()}bindBuffer(e,r){this.#e.bindBuffer(e,r)}bufferData(e,r,t){this.#e.bufferData(e,r,t)}enableVertexAttribArray(e){this.#e.enableVertexAttribArray(e)}vertexAttribPointer(e,r,t,o,i,a){this.#e.vertexAttribPointer(e,r,t,o,i,a)}uniformMatrix4fv(e,r,t){this.#e.uniformMatrix4fv(e,r,t)}uniform3fv(e,r){this.#e.uniform3fv(e,r)}getUniformLocation(e,r){return this.#e.getUniformLocation(e,r)}clearColor(e){this.#e.clearColor(e.r,e.g,e.b,e.a),this.#e.clear(this.#e.COLOR_BUFFER_BIT)}draw(e,r){this.#e.drawArraysInstanced(this.#e.TRIANGLES,0,e,r)}drawElements(e){this.#e.drawElements(this.#e.TRIANGLES,e,this.#e.UNSIGNED_SHORT,0)}drawIndexed(e,r){this.#e.drawElementsInstanced(this.#e.TRIANGLE_STRIP,e,this.#e.UNSIGNED_SHORT,0,r)}enableDepthTest(){this.#e.enable(this.#e.DEPTH_TEST)}disableDepthTest(){this.#e.disable(this.#e.DEPTH_TEST)}depthFunc(e){this.#e.depthFunc(e)}clearDepth(e){this.#e.clearDepth(e),this.#e.clear(this.#e.DEPTH_BUFFER_BIT)}createDepthTexture(e,r){const t=this.#e,o=t.createTexture();if(!o)throw new Error("Failed to create depth texture");return t.bindTexture(t.TEXTURE_2D,o),t.texImage2D(t.TEXTURE_2D,0,t.DEPTH_COMPONENT24,e,r,0,t.DEPTH_COMPONENT,t.UNSIGNED_INT,null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE,t.COMPARE_REF_TO_TEXTURE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_FUNC,t.LESS),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null),o}createDepthFramebuffer(e){const r=this.#e,t=r.createFramebuffer();if(!t)throw new Error("Failed to create shadow framebuffer");r.bindFramebuffer(r.FRAMEBUFFER,t),r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_ATTACHMENT,r.TEXTURE_2D,e,0),r.drawBuffers([r.NONE]),r.readBuffer(r.NONE);const o=r.checkFramebufferStatus(r.FRAMEBUFFER);if(o!==r.FRAMEBUFFER_COMPLETE)throw new Error(`Incomplete shadow framebuffer: 0x${o.toString(16)}`);return r.bindFramebuffer(r.FRAMEBUFFER,null),t}bindDepthFramebuffer(e){this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,e),this.#e.colorMask(!1,!1,!1,!1)}restoreFramebufferDefaultState(){this.#e.bindVertexArray(null),this.#e.bindFramebuffer(this.#e.FRAMEBUFFER,null),this.#e.colorMask(!0,!0,!0,!0)}deleteTexture(e){this.#e.deleteTexture(e)}deleteFramebuffer(e){this.#e.deleteFramebuffer(e)}bindTextureToSamplerForRawDepth(e,r){const t=this.#e;t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e);const o=t.getTexParameter(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE);return o!==t.NONE&&t.texParameteri(t.TEXTURE_2D,t.TEXTURE_COMPARE_MODE,t.NONE),t.uniform1i(r,0),o}restoreTextureState(e){const r=this.#e;r.bindVertexArray(null),e!==r.NONE&&r.texParameteri(r.TEXTURE_2D,r.TEXTURE_COMPARE_MODE,e),r.bindTexture(r.TEXTURE_2D,null),r.enable(r.DEPTH_TEST)}}(T.getContext("webgl2")),m=new class{#h;constructor(e){this.#h=new f(e)}render(e,r){this.#h.recordCommands(e,r)}}(d);!function e(){m.render(T.width,T.height),requestAnimationFrame(e)}()})();