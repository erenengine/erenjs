import SHADER_STR from './shaders/shader.wgsl';
import { flattenVertices, VERTEX_DESC } from './vertex';
import { mat4, vec2, vec3 } from 'gl-matrix';
import { flattenUBO } from './ubo';
const CLEAR_COLOR = { r: 0.1921, g: 0.302, b: 0.4745, a: 1 };
const TEST_VERTICES = [{
        pos: vec2.fromValues(-0.5, -0.5),
        color: vec3.fromValues(1, 0, 0),
    }, {
        pos: vec2.fromValues(0.5, -0.5),
        color: vec3.fromValues(0, 1, 0),
    }, {
        pos: vec2.fromValues(0.5, 0.5),
        color: vec3.fromValues(0, 0, 1),
    }, {
        pos: vec2.fromValues(-0.5, 0.5),
        color: vec3.fromValues(1, 1, 1),
    }];
const TEST_INDICES = [0, 1, 2, 2, 3, 0];
function createCombinedBuffer(device) {
    const flatVertexData = flattenVertices(TEST_VERTICES);
    const vertexFloatLength = flatVertexData.length;
    const vertexSize = vertexFloatLength * 4;
    const indexCount = TEST_INDICES.length;
    const indexSize = indexCount * 2;
    const indexOffset = (vertexSize + 3) & ~3; // 4-byte alignment
    const totalSize = indexOffset + indexSize;
    const buffer = device.createBuffer({
        label: 'Test Buffer',
        size: totalSize,
        usage: GPUBufferUsage.VERTEX | GPUBufferUsage.INDEX | GPUBufferUsage.COPY_DST,
        mappedAtCreation: true,
    });
    const mapping = new Uint8Array(buffer.getMappedRange());
    new Float32Array(mapping.buffer).set(flatVertexData);
    new Uint16Array(mapping.buffer, indexOffset, indexCount).set(TEST_INDICES);
    buffer.unmap();
    return {
        buffer,
        vertexOffset: 0,
        indexOffset,
        indexCount,
    };
}
export class TestRenderPass {
    #device;
    #bindGroup;
    #computePipeline;
    #graphicsPipeline;
    #combinedBuffer;
    #uboBuffer;
    #startTime;
    constructor(device, format) {
        this.#device = device;
        let shaderModule = device.createShaderModule({ label: 'Test Shader', code: SHADER_STR });
        const uboSize = 64; // 16 floats * 4 bytes = 64 bytes
        this.#uboBuffer = device.createBuffer({
            label: 'UBO Buffer',
            size: uboSize,
            usage: GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST,
        });
        const mat4Size = 4 * 4 * 4; // 4x4 float32 = 16 floats * 4 bytes = 64 bytes
        const ssboSize = mat4Size * 3; // model + view + proj = 3 * 64 = 192 bytes
        const ssboBuffer = device.createBuffer({
            label: 'SSBO Buffer',
            size: ssboSize,
            usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_DST,
        });
        const bindGroupLayout = device.createBindGroupLayout({
            label: 'Bind Group Layout',
            entries: [{
                    binding: 0,
                    visibility: GPUShaderStage.VERTEX,
                    buffer: { type: 'uniform' },
                }, {
                    binding: 1,
                    visibility: GPUShaderStage.VERTEX,
                    buffer: { type: 'storage' },
                }],
        });
        this.#bindGroup = device.createBindGroup({
            label: 'Bind Group',
            layout: bindGroupLayout,
            entries: [{
                    binding: 0,
                    resource: { buffer: this.#uboBuffer },
                }, {
                    binding: 1,
                    resource: { buffer: ssboBuffer },
                }],
        });
        let pipelineLayout = device.createPipelineLayout({
            label: 'Test Pipeline Layout',
            bindGroupLayouts: [bindGroupLayout],
            // WebGPU에서는 pushConstantRanges를 지원하지 않음
        });
        this.#computePipeline = device.createComputePipeline({
            label: 'Test Compute Pipeline',
            layout: pipelineLayout,
            module: shaderModule,
            entryPoint: 'compute_mvp',
        });
        this.#graphicsPipeline = device.createRenderPipeline({
            label: 'Test Pipeline',
            layout: pipelineLayout,
            vertex: {
                module: shaderModule,
                entryPoint: 'vs_main',
                buffers: [VERTEX_DESC],
            },
            fragment: {
                module: shaderModule,
                entryPoint: 'fs_main',
                targets: [{ format }],
            },
            primitive: {
                topology: 'triangle-strip',
                stripIndexFormat: 'uint16',
            },
        });
        this.#combinedBuffer = createCombinedBuffer(device);
        this.#startTime = Date.now();
    }
    #updateUniformBuffer(canvasWidth, canvasHeight) {
        const now = (performance.now() - this.#startTime) / 1000.0;
        const ubo = {
            model: mat4.create(),
            view: mat4.create(),
            proj: mat4.create(),
        };
        mat4.fromZRotation(ubo.model, -(now * 90 * Math.PI) / 180);
        const eye = vec3.fromValues(2, 2, 2);
        const center = vec3.fromValues(0, 0, 0);
        const up = vec3.fromValues(0, 0, 1);
        mat4.lookAt(ubo.view, eye, center, up);
        const aspect = canvasWidth / canvasHeight;
        mat4.perspective(ubo.proj, Math.PI / 4, aspect, 0.1, 10);
        this.#device.queue.writeBuffer(this.#uboBuffer, 0, flattenUBO(ubo));
    }
    recordCommands(encoder, view, canvasWidth, canvasHeight) {
        const passEncoder = encoder.beginRenderPass({
            colorAttachments: [{
                    view,
                    loadOp: 'clear',
                    storeOp: 'store',
                    clearValue: CLEAR_COLOR,
                }],
        });
        passEncoder.setPipeline(this.#graphicsPipeline);
        passEncoder.setVertexBuffer(0, this.#combinedBuffer.buffer, this.#combinedBuffer.vertexOffset);
        passEncoder.setIndexBuffer(this.#combinedBuffer.buffer, 'uint16', this.#combinedBuffer.indexOffset);
        this.#updateUniformBuffer(canvasWidth, canvasHeight);
        passEncoder.setBindGroup(0, this.#bindGroup);
        passEncoder.drawIndexed(this.#combinedBuffer.indexCount, 1, 0, 0, 0);
        passEncoder.end();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLXBhc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZW5kZXItcGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFVBQVUsTUFBTSx1QkFBdUIsQ0FBQztBQUUvQyxPQUFPLEVBQUUsZUFBZSxFQUFVLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNoRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDN0MsT0FBTyxFQUFFLFVBQVUsRUFBdUIsTUFBTSxPQUFPLENBQUM7QUFFeEQsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7QUFFN0QsTUFBTSxhQUFhLEdBQWEsQ0FBQztRQUMvQixHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQztRQUNoQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNoQyxFQUFFO1FBQ0QsR0FBRyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDO1FBQy9CLEtBQUssRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hDLEVBQUU7UUFDRCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO1FBQzlCLEtBQUssRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hDLEVBQUU7UUFDRCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7UUFDL0IsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDaEMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxZQUFZLEdBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBU2xELFNBQVMsb0JBQW9CLENBQUMsTUFBYztJQUMxQyxNQUFNLGNBQWMsR0FBRyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdEQsTUFBTSxpQkFBaUIsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDO0lBQ2hELE1BQU0sVUFBVSxHQUFHLGlCQUFpQixHQUFHLENBQUMsQ0FBQztJQUN6QyxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDO0lBQ3ZDLE1BQU0sU0FBUyxHQUFHLFVBQVUsR0FBRyxDQUFDLENBQUM7SUFFakMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxtQkFBbUI7SUFDOUQsTUFBTSxTQUFTLEdBQUcsV0FBVyxHQUFHLFNBQVMsQ0FBQztJQUUxQyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO1FBQ2pDLEtBQUssRUFBRSxhQUFhO1FBQ3BCLElBQUksRUFBRSxTQUFTO1FBQ2YsS0FBSyxFQUFFLGNBQWMsQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDLEtBQUssR0FBRyxjQUFjLENBQUMsUUFBUTtRQUM3RSxnQkFBZ0IsRUFBRSxJQUFJO0tBQ3ZCLENBQUMsQ0FBQztJQUVILE1BQU0sT0FBTyxHQUFHLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO0lBQ3hELElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDckQsSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzNFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUVmLE9BQU87UUFDTCxNQUFNO1FBQ04sWUFBWSxFQUFFLENBQUM7UUFDZixXQUFXO1FBQ1gsVUFBVTtLQUNYLENBQUM7QUFDSixDQUFDO0FBR0QsTUFBTSxPQUFPLGNBQWM7SUFDekIsT0FBTyxDQUFTO0lBRWhCLFVBQVUsQ0FBZTtJQUN6QixnQkFBZ0IsQ0FBcUI7SUFDckMsaUJBQWlCLENBQW9CO0lBRXJDLGVBQWUsQ0FBaUI7SUFDaEMsVUFBVSxDQUFZO0lBRXRCLFVBQVUsQ0FBUztJQUVuQixZQUFZLE1BQWMsRUFBRSxNQUF3QjtRQUNsRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUV0QixJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsa0JBQWtCLENBQUMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRXpGLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQyxDQUFDLGlDQUFpQztRQUVyRCxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDcEMsS0FBSyxFQUFFLFlBQVk7WUFDbkIsSUFBSSxFQUFFLE9BQU87WUFDYixLQUFLLEVBQUUsY0FBYyxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUMsUUFBUTtTQUN4RCxDQUFDLENBQUM7UUFFSCxNQUFNLFFBQVEsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLCtDQUErQztRQUMzRSxNQUFNLFFBQVEsR0FBRyxRQUFRLEdBQUcsQ0FBQyxDQUFDLENBQUMsMkNBQTJDO1FBRTFFLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUM7WUFDckMsS0FBSyxFQUFFLGFBQWE7WUFDcEIsSUFBSSxFQUFFLFFBQVE7WUFDZCxLQUFLLEVBQUUsY0FBYyxDQUFDLE9BQU8sR0FBRyxjQUFjLENBQUMsUUFBUTtTQUN4RCxDQUFDLENBQUM7UUFFSCxNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUM7WUFDbkQsS0FBSyxFQUFFLG1CQUFtQjtZQUMxQixPQUFPLEVBQUUsQ0FBQztvQkFDUixPQUFPLEVBQUUsQ0FBQztvQkFDVixVQUFVLEVBQUUsY0FBYyxDQUFDLE1BQU07b0JBQ2pDLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUU7aUJBQzVCLEVBQUU7b0JBQ0QsT0FBTyxFQUFFLENBQUM7b0JBQ1YsVUFBVSxFQUFFLGNBQWMsQ0FBQyxNQUFNO29CQUNqQyxNQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFO2lCQUM1QixDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsZUFBZSxDQUFDO1lBQ3ZDLEtBQUssRUFBRSxZQUFZO1lBQ25CLE1BQU0sRUFBRSxlQUFlO1lBQ3ZCLE9BQU8sRUFBRSxDQUFDO29CQUNSLE9BQU8sRUFBRSxDQUFDO29CQUNWLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFO2lCQUN0QyxFQUFFO29CQUNELE9BQU8sRUFBRSxDQUFDO29CQUNWLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUU7aUJBQ2pDLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxJQUFJLGNBQWMsR0FBRyxNQUFNLENBQUMsb0JBQW9CLENBQUM7WUFDL0MsS0FBSyxFQUFFLHNCQUFzQjtZQUM3QixnQkFBZ0IsRUFBRSxDQUFDLGVBQWUsQ0FBQztZQUNuQyx3Q0FBd0M7U0FDekMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsQ0FBQztZQUNuRCxLQUFLLEVBQUUsdUJBQXVCO1lBQzlCLE1BQU0sRUFBRSxjQUFjO1lBQ3RCLE1BQU0sRUFBRSxZQUFZO1lBQ3BCLFVBQVUsRUFBRSxhQUFhO1NBQzFCLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxpQkFBaUIsR0FBRyxNQUFNLENBQUMsb0JBQW9CLENBQUM7WUFDbkQsS0FBSyxFQUFFLGVBQWU7WUFDdEIsTUFBTSxFQUFFLGNBQWM7WUFDdEIsTUFBTSxFQUFFO2dCQUNOLE1BQU0sRUFBRSxZQUFZO2dCQUNwQixVQUFVLEVBQUUsU0FBUztnQkFDckIsT0FBTyxFQUFFLENBQUMsV0FBVyxDQUFDO2FBQ3ZCO1lBQ0QsUUFBUSxFQUFFO2dCQUNSLE1BQU0sRUFBRSxZQUFZO2dCQUNwQixVQUFVLEVBQUUsU0FBUztnQkFDckIsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQzthQUN0QjtZQUNELFNBQVMsRUFBRTtnQkFDVCxRQUFRLEVBQUUsZ0JBQWdCO2dCQUMxQixnQkFBZ0IsRUFBRSxRQUFRO2FBQzNCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGVBQWUsR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsb0JBQW9CLENBQUMsV0FBbUIsRUFBRSxZQUFvQjtRQUM1RCxNQUFNLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBRTNELE1BQU0sR0FBRyxHQUF3QjtZQUMvQixLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNwQixJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNuQixJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtTQUNwQixDQUFDO1FBRUYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxHQUFHLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUUzRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUV2QyxNQUFNLE1BQU0sR0FBRyxXQUFXLEdBQUcsWUFBWSxDQUFDO1FBQzFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXpELElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQsY0FBYyxDQUFDLE9BQTBCLEVBQUUsSUFBb0IsRUFBRSxXQUFtQixFQUFFLFlBQW9CO1FBQ3hHLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUM7WUFDMUMsZ0JBQWdCLEVBQUUsQ0FBQztvQkFDakIsSUFBSTtvQkFDSixNQUFNLEVBQUUsT0FBTztvQkFDZixPQUFPLEVBQUUsT0FBTztvQkFDaEIsVUFBVSxFQUFFLFdBQVc7aUJBQ3hCLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRWhELFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0YsV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVwRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3JELFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUU3QyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNwQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU0hBREVSX1NUUiBmcm9tICcuL3NoYWRlcnMvc2hhZGVyLndnc2wnO1xuaW1wb3J0IHsgRGV2aWNlIH0gZnJvbSAnLi4vLi4vZGlzdC9kZXZpY2UuanMnO1xuaW1wb3J0IHsgZmxhdHRlblZlcnRpY2VzLCBWZXJ0ZXgsIFZFUlRFWF9ERVNDIH0gZnJvbSAnLi92ZXJ0ZXgnO1xuaW1wb3J0IHsgbWF0NCwgdmVjMiwgdmVjMyB9IGZyb20gJ2dsLW1hdHJpeCc7XG5pbXBvcnQgeyBmbGF0dGVuVUJPLCBVbmlmb3JtQnVmZmVyT2JqZWN0IH0gZnJvbSAnLi91Ym8nO1xuXG5jb25zdCBDTEVBUl9DT0xPUiA9IHsgcjogMC4xOTIxLCBnOiAwLjMwMiwgYjogMC40NzQ1LCBhOiAxIH07XG5cbmNvbnN0IFRFU1RfVkVSVElDRVM6IFZlcnRleFtdID0gW3tcbiAgcG9zOiB2ZWMyLmZyb21WYWx1ZXMoLTAuNSwgLTAuNSksXG4gIGNvbG9yOiB2ZWMzLmZyb21WYWx1ZXMoMSwgMCwgMCksXG59LCB7XG4gIHBvczogdmVjMi5mcm9tVmFsdWVzKDAuNSwgLTAuNSksXG4gIGNvbG9yOiB2ZWMzLmZyb21WYWx1ZXMoMCwgMSwgMCksXG59LCB7XG4gIHBvczogdmVjMi5mcm9tVmFsdWVzKDAuNSwgMC41KSxcbiAgY29sb3I6IHZlYzMuZnJvbVZhbHVlcygwLCAwLCAxKSxcbn0sIHtcbiAgcG9zOiB2ZWMyLmZyb21WYWx1ZXMoLTAuNSwgMC41KSxcbiAgY29sb3I6IHZlYzMuZnJvbVZhbHVlcygxLCAxLCAxKSxcbn1dO1xuXG5jb25zdCBURVNUX0lORElDRVM6IG51bWJlcltdID0gWzAsIDEsIDIsIDIsIDMsIDBdO1xuXG5pbnRlcmZhY2UgQ29tYmluZWRCdWZmZXIge1xuICBidWZmZXI6IEdQVUJ1ZmZlcjtcbiAgdmVydGV4T2Zmc2V0OiBudW1iZXI7XG4gIGluZGV4T2Zmc2V0OiBudW1iZXI7XG4gIGluZGV4Q291bnQ6IG51bWJlcjtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQ29tYmluZWRCdWZmZXIoZGV2aWNlOiBEZXZpY2UpOiBDb21iaW5lZEJ1ZmZlciB7XG4gIGNvbnN0IGZsYXRWZXJ0ZXhEYXRhID0gZmxhdHRlblZlcnRpY2VzKFRFU1RfVkVSVElDRVMpO1xuICBjb25zdCB2ZXJ0ZXhGbG9hdExlbmd0aCA9IGZsYXRWZXJ0ZXhEYXRhLmxlbmd0aDtcbiAgY29uc3QgdmVydGV4U2l6ZSA9IHZlcnRleEZsb2F0TGVuZ3RoICogNDtcbiAgY29uc3QgaW5kZXhDb3VudCA9IFRFU1RfSU5ESUNFUy5sZW5ndGg7XG4gIGNvbnN0IGluZGV4U2l6ZSA9IGluZGV4Q291bnQgKiAyO1xuXG4gIGNvbnN0IGluZGV4T2Zmc2V0ID0gKHZlcnRleFNpemUgKyAzKSAmIH4zOyAvLyA0LWJ5dGUgYWxpZ25tZW50XG4gIGNvbnN0IHRvdGFsU2l6ZSA9IGluZGV4T2Zmc2V0ICsgaW5kZXhTaXplO1xuXG4gIGNvbnN0IGJ1ZmZlciA9IGRldmljZS5jcmVhdGVCdWZmZXIoe1xuICAgIGxhYmVsOiAnVGVzdCBCdWZmZXInLFxuICAgIHNpemU6IHRvdGFsU2l6ZSxcbiAgICB1c2FnZTogR1BVQnVmZmVyVXNhZ2UuVkVSVEVYIHwgR1BVQnVmZmVyVXNhZ2UuSU5ERVggfCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCxcbiAgICBtYXBwZWRBdENyZWF0aW9uOiB0cnVlLFxuICB9KTtcblxuICBjb25zdCBtYXBwaW5nID0gbmV3IFVpbnQ4QXJyYXkoYnVmZmVyLmdldE1hcHBlZFJhbmdlKCkpO1xuICBuZXcgRmxvYXQzMkFycmF5KG1hcHBpbmcuYnVmZmVyKS5zZXQoZmxhdFZlcnRleERhdGEpO1xuICBuZXcgVWludDE2QXJyYXkobWFwcGluZy5idWZmZXIsIGluZGV4T2Zmc2V0LCBpbmRleENvdW50KS5zZXQoVEVTVF9JTkRJQ0VTKTtcbiAgYnVmZmVyLnVubWFwKCk7XG5cbiAgcmV0dXJuIHtcbiAgICBidWZmZXIsXG4gICAgdmVydGV4T2Zmc2V0OiAwLFxuICAgIGluZGV4T2Zmc2V0LFxuICAgIGluZGV4Q291bnQsXG4gIH07XG59XG5cblxuZXhwb3J0IGNsYXNzIFRlc3RSZW5kZXJQYXNzIHtcbiAgI2RldmljZTogRGV2aWNlO1xuXG4gICNiaW5kR3JvdXA6IEdQVUJpbmRHcm91cDtcbiAgI2NvbXB1dGVQaXBlbGluZTogR1BVQ29tcHV0ZVBpcGVsaW5lO1xuICAjZ3JhcGhpY3NQaXBlbGluZTogR1BVUmVuZGVyUGlwZWxpbmU7XG5cbiAgI2NvbWJpbmVkQnVmZmVyOiBDb21iaW5lZEJ1ZmZlcjtcbiAgI3Vib0J1ZmZlcjogR1BVQnVmZmVyO1xuXG4gICNzdGFydFRpbWU6IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihkZXZpY2U6IERldmljZSwgZm9ybWF0OiBHUFVUZXh0dXJlRm9ybWF0KSB7XG4gICAgdGhpcy4jZGV2aWNlID0gZGV2aWNlO1xuXG4gICAgbGV0IHNoYWRlck1vZHVsZSA9IGRldmljZS5jcmVhdGVTaGFkZXJNb2R1bGUoeyBsYWJlbDogJ1Rlc3QgU2hhZGVyJywgY29kZTogU0hBREVSX1NUUiB9KTtcblxuICAgIGNvbnN0IHVib1NpemUgPSA2NDsgLy8gMTYgZmxvYXRzICogNCBieXRlcyA9IDY0IGJ5dGVzXG5cbiAgICB0aGlzLiN1Ym9CdWZmZXIgPSBkZXZpY2UuY3JlYXRlQnVmZmVyKHtcbiAgICAgIGxhYmVsOiAnVUJPIEJ1ZmZlcicsXG4gICAgICBzaXplOiB1Ym9TaXplLFxuICAgICAgdXNhZ2U6IEdQVUJ1ZmZlclVzYWdlLlVOSUZPUk0gfCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCxcbiAgICB9KTtcblxuICAgIGNvbnN0IG1hdDRTaXplID0gNCAqIDQgKiA0OyAvLyA0eDQgZmxvYXQzMiA9IDE2IGZsb2F0cyAqIDQgYnl0ZXMgPSA2NCBieXRlc1xuICAgIGNvbnN0IHNzYm9TaXplID0gbWF0NFNpemUgKiAzOyAvLyBtb2RlbCArIHZpZXcgKyBwcm9qID0gMyAqIDY0ID0gMTkyIGJ5dGVzXG5cbiAgICBjb25zdCBzc2JvQnVmZmVyID0gZGV2aWNlLmNyZWF0ZUJ1ZmZlcih7XG4gICAgICBsYWJlbDogJ1NTQk8gQnVmZmVyJyxcbiAgICAgIHNpemU6IHNzYm9TaXplLFxuICAgICAgdXNhZ2U6IEdQVUJ1ZmZlclVzYWdlLlNUT1JBR0UgfCBHUFVCdWZmZXJVc2FnZS5DT1BZX0RTVCxcbiAgICB9KTtcblxuICAgIGNvbnN0IGJpbmRHcm91cExheW91dCA9IGRldmljZS5jcmVhdGVCaW5kR3JvdXBMYXlvdXQoe1xuICAgICAgbGFiZWw6ICdCaW5kIEdyb3VwIExheW91dCcsXG4gICAgICBlbnRyaWVzOiBbe1xuICAgICAgICBiaW5kaW5nOiAwLFxuICAgICAgICB2aXNpYmlsaXR5OiBHUFVTaGFkZXJTdGFnZS5WRVJURVgsXG4gICAgICAgIGJ1ZmZlcjogeyB0eXBlOiAndW5pZm9ybScgfSxcbiAgICAgIH0sIHtcbiAgICAgICAgYmluZGluZzogMSxcbiAgICAgICAgdmlzaWJpbGl0eTogR1BVU2hhZGVyU3RhZ2UuVkVSVEVYLFxuICAgICAgICBidWZmZXI6IHsgdHlwZTogJ3N0b3JhZ2UnIH0sXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIHRoaXMuI2JpbmRHcm91cCA9IGRldmljZS5jcmVhdGVCaW5kR3JvdXAoe1xuICAgICAgbGFiZWw6ICdCaW5kIEdyb3VwJyxcbiAgICAgIGxheW91dDogYmluZEdyb3VwTGF5b3V0LFxuICAgICAgZW50cmllczogW3tcbiAgICAgICAgYmluZGluZzogMCxcbiAgICAgICAgcmVzb3VyY2U6IHsgYnVmZmVyOiB0aGlzLiN1Ym9CdWZmZXIgfSxcbiAgICAgIH0sIHtcbiAgICAgICAgYmluZGluZzogMSxcbiAgICAgICAgcmVzb3VyY2U6IHsgYnVmZmVyOiBzc2JvQnVmZmVyIH0sXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIGxldCBwaXBlbGluZUxheW91dCA9IGRldmljZS5jcmVhdGVQaXBlbGluZUxheW91dCh7XG4gICAgICBsYWJlbDogJ1Rlc3QgUGlwZWxpbmUgTGF5b3V0JyxcbiAgICAgIGJpbmRHcm91cExheW91dHM6IFtiaW5kR3JvdXBMYXlvdXRdLFxuICAgICAgLy8gV2ViR1BV7JeQ7ISc64qUIHB1c2hDb25zdGFudFJhbmdlc+ulvCDsp4Dsm5DtlZjsp4Ag7JWK7J2MXG4gICAgfSk7XG5cbiAgICB0aGlzLiNjb21wdXRlUGlwZWxpbmUgPSBkZXZpY2UuY3JlYXRlQ29tcHV0ZVBpcGVsaW5lKHtcbiAgICAgIGxhYmVsOiAnVGVzdCBDb21wdXRlIFBpcGVsaW5lJyxcbiAgICAgIGxheW91dDogcGlwZWxpbmVMYXlvdXQsXG4gICAgICBtb2R1bGU6IHNoYWRlck1vZHVsZSxcbiAgICAgIGVudHJ5UG9pbnQ6ICdjb21wdXRlX212cCcsXG4gICAgfSk7XG5cbiAgICB0aGlzLiNncmFwaGljc1BpcGVsaW5lID0gZGV2aWNlLmNyZWF0ZVJlbmRlclBpcGVsaW5lKHtcbiAgICAgIGxhYmVsOiAnVGVzdCBQaXBlbGluZScsXG4gICAgICBsYXlvdXQ6IHBpcGVsaW5lTGF5b3V0LFxuICAgICAgdmVydGV4OiB7XG4gICAgICAgIG1vZHVsZTogc2hhZGVyTW9kdWxlLFxuICAgICAgICBlbnRyeVBvaW50OiAndnNfbWFpbicsXG4gICAgICAgIGJ1ZmZlcnM6IFtWRVJURVhfREVTQ10sXG4gICAgICB9LFxuICAgICAgZnJhZ21lbnQ6IHtcbiAgICAgICAgbW9kdWxlOiBzaGFkZXJNb2R1bGUsXG4gICAgICAgIGVudHJ5UG9pbnQ6ICdmc19tYWluJyxcbiAgICAgICAgdGFyZ2V0czogW3sgZm9ybWF0IH1dLFxuICAgICAgfSxcbiAgICAgIHByaW1pdGl2ZToge1xuICAgICAgICB0b3BvbG9neTogJ3RyaWFuZ2xlLXN0cmlwJyxcbiAgICAgICAgc3RyaXBJbmRleEZvcm1hdDogJ3VpbnQxNicsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy4jY29tYmluZWRCdWZmZXIgPSBjcmVhdGVDb21iaW5lZEJ1ZmZlcihkZXZpY2UpO1xuICAgIHRoaXMuI3N0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gIH1cblxuICAjdXBkYXRlVW5pZm9ybUJ1ZmZlcihjYW52YXNXaWR0aDogbnVtYmVyLCBjYW52YXNIZWlnaHQ6IG51bWJlcikge1xuICAgIGNvbnN0IG5vdyA9IChwZXJmb3JtYW5jZS5ub3coKSAtIHRoaXMuI3N0YXJ0VGltZSkgLyAxMDAwLjA7XG5cbiAgICBjb25zdCB1Ym86IFVuaWZvcm1CdWZmZXJPYmplY3QgPSB7XG4gICAgICBtb2RlbDogbWF0NC5jcmVhdGUoKSxcbiAgICAgIHZpZXc6IG1hdDQuY3JlYXRlKCksXG4gICAgICBwcm9qOiBtYXQ0LmNyZWF0ZSgpLFxuICAgIH07XG5cbiAgICBtYXQ0LmZyb21aUm90YXRpb24odWJvLm1vZGVsLCAtKG5vdyAqIDkwICogTWF0aC5QSSkgLyAxODApO1xuXG4gICAgY29uc3QgZXllID0gdmVjMy5mcm9tVmFsdWVzKDIsIDIsIDIpO1xuICAgIGNvbnN0IGNlbnRlciA9IHZlYzMuZnJvbVZhbHVlcygwLCAwLCAwKTtcbiAgICBjb25zdCB1cCA9IHZlYzMuZnJvbVZhbHVlcygwLCAwLCAxKTtcbiAgICBtYXQ0Lmxvb2tBdCh1Ym8udmlldywgZXllLCBjZW50ZXIsIHVwKTtcblxuICAgIGNvbnN0IGFzcGVjdCA9IGNhbnZhc1dpZHRoIC8gY2FudmFzSGVpZ2h0O1xuICAgIG1hdDQucGVyc3BlY3RpdmUodWJvLnByb2osIE1hdGguUEkgLyA0LCBhc3BlY3QsIDAuMSwgMTApO1xuXG4gICAgdGhpcy4jZGV2aWNlLnF1ZXVlLndyaXRlQnVmZmVyKHRoaXMuI3Vib0J1ZmZlciwgMCwgZmxhdHRlblVCTyh1Ym8pKTtcbiAgfVxuXG4gIHJlY29yZENvbW1hbmRzKGVuY29kZXI6IEdQVUNvbW1hbmRFbmNvZGVyLCB2aWV3OiBHUFVUZXh0dXJlVmlldywgY2FudmFzV2lkdGg6IG51bWJlciwgY2FudmFzSGVpZ2h0OiBudW1iZXIpIHtcbiAgICBjb25zdCBwYXNzRW5jb2RlciA9IGVuY29kZXIuYmVnaW5SZW5kZXJQYXNzKHtcbiAgICAgIGNvbG9yQXR0YWNobWVudHM6IFt7XG4gICAgICAgIHZpZXcsXG4gICAgICAgIGxvYWRPcDogJ2NsZWFyJyxcbiAgICAgICAgc3RvcmVPcDogJ3N0b3JlJyxcbiAgICAgICAgY2xlYXJWYWx1ZTogQ0xFQVJfQ09MT1IsXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIHBhc3NFbmNvZGVyLnNldFBpcGVsaW5lKHRoaXMuI2dyYXBoaWNzUGlwZWxpbmUpO1xuXG4gICAgcGFzc0VuY29kZXIuc2V0VmVydGV4QnVmZmVyKDAsIHRoaXMuI2NvbWJpbmVkQnVmZmVyLmJ1ZmZlciwgdGhpcy4jY29tYmluZWRCdWZmZXIudmVydGV4T2Zmc2V0KTtcbiAgICBwYXNzRW5jb2Rlci5zZXRJbmRleEJ1ZmZlcih0aGlzLiNjb21iaW5lZEJ1ZmZlci5idWZmZXIsICd1aW50MTYnLCB0aGlzLiNjb21iaW5lZEJ1ZmZlci5pbmRleE9mZnNldCk7XG5cbiAgICB0aGlzLiN1cGRhdGVVbmlmb3JtQnVmZmVyKGNhbnZhc1dpZHRoLCBjYW52YXNIZWlnaHQpO1xuICAgIHBhc3NFbmNvZGVyLnNldEJpbmRHcm91cCgwLCB0aGlzLiNiaW5kR3JvdXApO1xuXG4gICAgcGFzc0VuY29kZXIuZHJhd0luZGV4ZWQodGhpcy4jY29tYmluZWRCdWZmZXIuaW5kZXhDb3VudCwgMSwgMCwgMCwgMCk7XG4gICAgcGFzc0VuY29kZXIuZW5kKCk7XG4gIH1cbn1cbiJdfQ==