import SHADER_STR from './shaders/shader.wgsl';
import { flattenVertices, VERTEX_DESC } from './vertex';
import { vec2, vec3 } from 'gl-matrix';
const CLEAR_COLOR = { r: 0.1921, g: 0.302, b: 0.4745, a: 1 };
const TEST_VERTICES = [{
        pos: vec2.fromValues(-0.5, -0.5),
        color: vec3.fromValues(1, 0, 0),
    }, {
        pos: vec2.fromValues(0.5, -0.5),
        color: vec3.fromValues(0, 1, 0),
    }, {
        pos: vec2.fromValues(0.5, 0.5),
        color: vec3.fromValues(0, 0, 1),
    }, {
        pos: vec2.fromValues(-0.5, 0.5),
        color: vec3.fromValues(1, 1, 1),
    }];
const TEST_INDICES = [0, 1, 2, 2, 3, 0];
function createCombinedBuffer(device) {
    const flatVertexData = flattenVertices(TEST_VERTICES);
    const vertexFloatLength = flatVertexData.length;
    const vertexSize = vertexFloatLength * 4;
    const indexCount = TEST_INDICES.length;
    const indexSize = indexCount * 2;
    const indexOffset = (vertexSize + 3) & ~3; // 4-byte alignment
    const totalSize = indexOffset + indexSize;
    const buffer = device.createBuffer({
        label: 'Test Buffer',
        size: totalSize,
        usage: GPUBufferUsage.VERTEX | GPUBufferUsage.INDEX | GPUBufferUsage.COPY_DST,
        mappedAtCreation: true,
    });
    const mapping = new Uint8Array(buffer.getMappedRange());
    new Float32Array(mapping.buffer).set(flatVertexData);
    new Uint16Array(mapping.buffer, indexOffset, indexCount).set(TEST_INDICES);
    buffer.unmap();
    return {
        buffer,
        vertexOffset: 0,
        indexOffset,
        indexCount,
    };
}
export class TestRenderPass {
    #device;
    #pipeline;
    #combinedBuffer;
    constructor(device, format) {
        this.#device = device;
        let shaderModule = device.createShaderModule({ label: 'Test Shader', code: SHADER_STR });
        let pipelineLayout = device.createPipelineLayout({
            label: 'Test Pipeline Layout',
            bindGroupLayouts: [],
            // WebGPU에서는 pushConstantRanges를 지원하지 않음
        });
        this.#pipeline = device.createRenderPipeline({
            label: 'Test Pipeline',
            layout: pipelineLayout,
            vertex: {
                module: shaderModule,
                entryPoint: 'vs_main',
                buffers: [VERTEX_DESC],
            },
            fragment: {
                module: shaderModule,
                entryPoint: 'fs_main',
                targets: [{ format }],
            },
            primitive: {
                topology: 'triangle-strip',
                stripIndexFormat: 'uint16',
            },
        });
        this.#combinedBuffer = createCombinedBuffer(device);
    }
    recordCommands(encoder, view) {
        const passEncoder = encoder.beginRenderPass({
            colorAttachments: [{
                    view,
                    loadOp: 'clear',
                    storeOp: 'store',
                    clearValue: CLEAR_COLOR,
                }],
        });
        passEncoder.setPipeline(this.#pipeline);
        passEncoder.setVertexBuffer(0, this.#combinedBuffer.buffer, this.#combinedBuffer.vertexOffset);
        passEncoder.setIndexBuffer(this.#combinedBuffer.buffer, 'uint16', this.#combinedBuffer.indexOffset);
        passEncoder.drawIndexed(this.#combinedBuffer.indexCount, 1, 0, 0, 0);
        passEncoder.end();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLXBhc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZW5kZXItcGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFVBQVUsTUFBTSx1QkFBdUIsQ0FBQztBQUUvQyxPQUFPLEVBQUUsZUFBZSxFQUFVLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNoRSxPQUFPLEVBQVEsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUU3QyxNQUFNLFdBQVcsR0FBRyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztBQUU3RCxNQUFNLGFBQWEsR0FBYSxDQUFDO1FBQy9CLEdBQUcsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDO1FBQ2hDLEtBQUssRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hDLEVBQUU7UUFDRCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLENBQUM7UUFDL0IsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDaEMsRUFBRTtRQUNELEdBQUcsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7UUFDOUIsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDaEMsRUFBRTtRQUNELEdBQUcsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQztRQUMvQixLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxF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RUQsY0FBYyxDQUFDLE9BQTBCLEVBQUUsSUFBb0I7UUFDN0QsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQztZQUMxQyxnQkFBZ0IsRUFBRSxDQUFDO29CQUNqQixJQUFJO29CQUNKLE1BQU0sRUFBRSxPQUFPO29CQUNmLE9BQU8sRUFBRSxPQUFPO29CQUNoQixVQUFVLEVBQUUsV0FBVztpQkFDeEIsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILFdBQVcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXhDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0YsV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVwRyxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNwQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU0hBREVSX1NUUiBmcm9tICcuL3NoYWRlcnMvc2hhZGVyLndnc2wnO1xuaW1wb3J0IHsgRGV2aWNlIH0gZnJvbSAnLi4vLi4vZGlzdC9kZXZpY2UuanMnO1xuaW1wb3J0IHsgZmxhdHRlblZlcnRpY2VzLCBWZXJ0ZXgsIFZFUlRFWF9ERVNDIH0gZnJvbSAnLi92ZXJ0ZXgnO1xuaW1wb3J0IHsgbWF0NCwgdmVjMiwgdmVjMyB9IGZyb20gJ2dsLW1hdHJpeCc7XG5cbmNvbnN0IENMRUFSX0NPTE9SID0geyByOiAwLjE5MjEsIGc6IDAuMzAyLCBiOiAwLjQ3NDUsIGE6IDEgfTtcblxuY29uc3QgVEVTVF9WRVJUSUNFUzogVmVydGV4W10gPSBbe1xuICBwb3M6IHZlYzIuZnJvbVZhbHVlcygtMC41LCAtMC41KSxcbiAgY29sb3I6IHZlYzMuZnJvbVZhbHVlcygxLCAwLCAwKSxcbn0sIHtcbiAgcG9zOiB2ZWMyLmZyb21WYWx1ZXMoMC41LCAtMC41KSxcbiAgY29sb3I6IHZlYzMuZnJvbVZhbHVlcygwLCAxLCAwKSxcbn0sIHtcbiAgcG9zOiB2ZWMyLmZyb21WYWx1ZXMoMC41LCAwLjUpLFxuICBjb2xvcjogdmVjMy5mcm9tVmFsdWVzKDAsIDAsIDEpLFxufSwge1xuICBwb3M6IHZlYzIuZnJvbVZhbHVlcygtMC41LCAwLjUpLFxuICBjb2xvcjogdmVjMy5mcm9tVmFsdWVzKDEsIDEsIDEpLFxufV07XG5cbmNvbnN0IFRFU1RfSU5ESUNFUzogbnVtYmVyW10gPSBbMCwgMSwgMiwgMiwgMywgMF07XG5cbmludGVyZmFjZSBDb21iaW5lZEJ1ZmZlciB7XG4gIGJ1ZmZlcjogR1BVQnVmZmVyO1xuICB2ZXJ0ZXhPZmZzZXQ6IG51bWJlcjtcbiAgaW5kZXhPZmZzZXQ6IG51bWJlcjtcbiAgaW5kZXhDb3VudDogbnVtYmVyO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVDb21iaW5lZEJ1ZmZlcihkZXZpY2U6IERldmljZSk6IENvbWJpbmVkQnVmZmVyIHtcbiAgY29uc3QgZmxhdFZlcnRleERhdGEgPSBmbGF0dGVuVmVydGljZXMoVEVTVF9WRVJUSUNFUyk7XG4gIGNvbnN0IHZlcnRleEZsb2F0TGVuZ3RoID0gZmxhdFZlcnRleERhdGEubGVuZ3RoO1xuICBjb25zdCB2ZXJ0ZXhTaXplID0gdmVydGV4RmxvYXRMZW5ndGggKiA0O1xuICBjb25zdCBpbmRleENvdW50ID0gVEVTVF9JTkRJQ0VTLmxlbmd0aDtcbiAgY29uc3QgaW5kZXhTaXplID0gaW5kZXhDb3VudCAqIDI7XG5cbiAgY29uc3QgaW5kZXhPZmZzZXQgPSAodmVydGV4U2l6ZSArIDMpICYgfjM7IC8vIDQtYnl0ZSBhbGlnbm1lbnRcbiAgY29uc3QgdG90YWxTaXplID0gaW5kZXhPZmZzZXQgKyBpbmRleFNpemU7XG5cbiAgY29uc3QgYnVmZmVyID0gZGV2aWNlLmNyZWF0ZUJ1ZmZlcih7XG4gICAgbGFiZWw6ICdUZXN0IEJ1ZmZlcicsXG4gICAgc2l6ZTogdG90YWxTaXplLFxuICAgIHVzYWdlOiBHUFVCdWZmZXJVc2FnZS5WRVJURVggfCBHUFVCdWZmZXJVc2FnZS5JTkRFWCB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNULFxuICAgIG1hcHBlZEF0Q3JlYXRpb246IHRydWUsXG4gIH0pO1xuXG4gIGNvbnN0IG1hcHBpbmcgPSBuZXcgVWludDhBcnJheShidWZmZXIuZ2V0TWFwcGVkUmFuZ2UoKSk7XG4gIG5ldyBGbG9hdDMyQXJyYXkobWFwcGluZy5idWZmZXIpLnNldChmbGF0VmVydGV4RGF0YSk7XG4gIG5ldyBVaW50MTZBcnJheShtYXBwaW5nLmJ1ZmZlciwgaW5kZXhPZmZzZXQsIGluZGV4Q291bnQpLnNldChURVNUX0lORElDRVMpO1xuICBidWZmZXIudW5tYXAoKTtcblxuICByZXR1cm4ge1xuICAgIGJ1ZmZlcixcbiAgICB2ZXJ0ZXhPZmZzZXQ6IDAsXG4gICAgaW5kZXhPZmZzZXQsXG4gICAgaW5kZXhDb3VudCxcbiAgfTtcbn1cblxuXG5leHBvcnQgY2xhc3MgVGVzdFJlbmRlclBhc3Mge1xuICAjZGV2aWNlOiBEZXZpY2U7XG4gICNwaXBlbGluZTogR1BVUmVuZGVyUGlwZWxpbmU7XG4gICNjb21iaW5lZEJ1ZmZlcjogQ29tYmluZWRCdWZmZXI7XG5cbiAgY29uc3RydWN0b3IoZGV2aWNlOiBEZXZpY2UsIGZvcm1hdDogR1BVVGV4dHVyZUZvcm1hdCkge1xuICAgIHRoaXMuI2RldmljZSA9IGRldmljZTtcblxuICAgIGxldCBzaGFkZXJNb2R1bGUgPSBkZXZpY2UuY3JlYXRlU2hhZGVyTW9kdWxlKHsgbGFiZWw6ICdUZXN0IFNoYWRlcicsIGNvZGU6IFNIQURFUl9TVFIgfSk7XG5cbiAgICBsZXQgcGlwZWxpbmVMYXlvdXQgPSBkZXZpY2UuY3JlYXRlUGlwZWxpbmVMYXlvdXQoe1xuICAgICAgbGFiZWw6ICdUZXN0IFBpcGVsaW5lIExheW91dCcsXG4gICAgICBiaW5kR3JvdXBMYXlvdXRzOiBbXSxcbiAgICAgIC8vIFdlYkdQVeyXkOyEnOuKlCBwdXNoQ29uc3RhbnRSYW5nZXPrpbwg7KeA7JuQ7ZWY7KeAIOyViuydjFxuICAgIH0pO1xuXG4gICAgdGhpcy4jcGlwZWxpbmUgPSBkZXZpY2UuY3JlYXRlUmVuZGVyUGlwZWxpbmUoe1xuICAgICAgbGFiZWw6ICdUZXN0IFBpcGVsaW5lJyxcbiAgICAgIGxheW91dDogcGlwZWxpbmVMYXlvdXQsXG4gICAgICB2ZXJ0ZXg6IHtcbiAgICAgICAgbW9kdWxlOiBzaGFkZXJNb2R1bGUsXG4gICAgICAgIGVudHJ5UG9pbnQ6ICd2c19tYWluJyxcbiAgICAgICAgYnVmZmVyczogW1ZFUlRFWF9ERVNDXSxcbiAgICAgIH0sXG4gICAgICBmcmFnbWVudDoge1xuICAgICAgICBtb2R1bGU6IHNoYWRlck1vZHVsZSxcbiAgICAgICAgZW50cnlQb2ludDogJ2ZzX21haW4nLFxuICAgICAgICB0YXJnZXRzOiBbeyBmb3JtYXQgfV0sXG4gICAgICB9LFxuICAgICAgcHJpbWl0aXZlOiB7XG4gICAgICAgIHRvcG9sb2d5OiAndHJpYW5nbGUtc3RyaXAnLFxuICAgICAgICBzdHJpcEluZGV4Rm9ybWF0OiAndWludDE2JyxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLiNjb21iaW5lZEJ1ZmZlciA9IGNyZWF0ZUNvbWJpbmVkQnVmZmVyKGRldmljZSk7XG4gIH1cblxuICByZWNvcmRDb21tYW5kcyhlbmNvZGVyOiBHUFVDb21tYW5kRW5jb2RlciwgdmlldzogR1BVVGV4dHVyZVZpZXcpIHtcbiAgICBjb25zdCBwYXNzRW5jb2RlciA9IGVuY29kZXIuYmVnaW5SZW5kZXJQYXNzKHtcbiAgICAgIGNvbG9yQXR0YWNobWVudHM6IFt7XG4gICAgICAgIHZpZXcsXG4gICAgICAgIGxvYWRPcDogJ2NsZWFyJyxcbiAgICAgICAgc3RvcmVPcDogJ3N0b3JlJyxcbiAgICAgICAgY2xlYXJWYWx1ZTogQ0xFQVJfQ09MT1IsXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIHBhc3NFbmNvZGVyLnNldFBpcGVsaW5lKHRoaXMuI3BpcGVsaW5lKTtcblxuICAgIHBhc3NFbmNvZGVyLnNldFZlcnRleEJ1ZmZlcigwLCB0aGlzLiNjb21iaW5lZEJ1ZmZlci5idWZmZXIsIHRoaXMuI2NvbWJpbmVkQnVmZmVyLnZlcnRleE9mZnNldCk7XG4gICAgcGFzc0VuY29kZXIuc2V0SW5kZXhCdWZmZXIodGhpcy4jY29tYmluZWRCdWZmZXIuYnVmZmVyLCAndWludDE2JywgdGhpcy4jY29tYmluZWRCdWZmZXIuaW5kZXhPZmZzZXQpO1xuXG4gICAgcGFzc0VuY29kZXIuZHJhd0luZGV4ZWQodGhpcy4jY29tYmluZWRCdWZmZXIuaW5kZXhDb3VudCwgMSwgMCwgMCwgMCk7XG4gICAgcGFzc0VuY29kZXIuZW5kKCk7XG4gIH1cbn1cbiJdfQ==