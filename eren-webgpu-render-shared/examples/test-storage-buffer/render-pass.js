import SHADER_STR from './shaders/shader.wgsl';
import { flattenVertices, VERTEX_DESC } from './vertex';
import { mat4, vec2, vec3 } from 'gl-matrix';
import { flattenSBO } from './ssbo';
const CLEAR_COLOR = { r: 0.1921, g: 0.302, b: 0.4745, a: 1 };
const TEST_VERTICES = [{
        pos: vec2.fromValues(-0.5, -0.5),
        color: vec3.fromValues(1, 0, 0),
    }, {
        pos: vec2.fromValues(0.5, -0.5),
        color: vec3.fromValues(0, 1, 0),
    }, {
        pos: vec2.fromValues(0.5, 0.5),
        color: vec3.fromValues(0, 0, 1),
    }, {
        pos: vec2.fromValues(-0.5, 0.5),
        color: vec3.fromValues(1, 1, 1),
    }];
const TEST_INDICES = [0, 1, 2, 2, 3, 0];
function createCombinedBuffer(device) {
    const flatVertexData = flattenVertices(TEST_VERTICES);
    const vertexFloatLength = flatVertexData.length;
    const vertexSize = vertexFloatLength * 4;
    const indexCount = TEST_INDICES.length;
    const indexSize = indexCount * 2;
    const indexOffset = (vertexSize + 3) & ~3; // 4-byte alignment
    const totalSize = indexOffset + indexSize;
    const buffer = device.createBuffer({
        label: 'Test Buffer',
        size: totalSize,
        usage: GPUBufferUsage.VERTEX | GPUBufferUsage.INDEX | GPUBufferUsage.COPY_DST,
        mappedAtCreation: true,
    });
    const mapping = new Uint8Array(buffer.getMappedRange());
    new Float32Array(mapping.buffer).set(flatVertexData);
    new Uint16Array(mapping.buffer, indexOffset, indexCount).set(TEST_INDICES);
    buffer.unmap();
    return {
        buffer,
        vertexOffset: 0,
        indexOffset,
        indexCount,
    };
}
export class TestRenderPass {
    #device;
    #pipeline;
    #combinedBuffer;
    #ssboBuffer;
    #ssboBindGroup;
    #startTime;
    constructor(device, format) {
        this.#device = device;
        let shaderModule = device.createShaderModule({ label: 'Test Shader', code: SHADER_STR });
        const mat4Size = 4 * 4 * 4; // 4x4 float32 = 16 floats * 4 bytes = 64 bytes
        const ssboSize = mat4Size * 3; // model + view + proj = 3 * 64 = 192 bytes
        this.#ssboBuffer = device.createBuffer({
            label: 'SSBO Buffer',
            size: ssboSize,
            usage: GPUBufferUsage.STORAGE | GPUBufferUsage.COPY_DST,
        });
        const ssboBindGroupLayout = device.createBindGroupLayout({
            label: 'SBO Bind Group Layout',
            entries: [{
                    binding: 0,
                    visibility: GPUShaderStage.VERTEX,
                    buffer: { type: 'read-only-storage' },
                }],
        });
        this.#ssboBindGroup = device.createBindGroup({
            label: 'SBO Bind Group',
            layout: ssboBindGroupLayout,
            entries: [{
                    binding: 0,
                    resource: { buffer: this.#ssboBuffer },
                }],
        });
        let pipelineLayout = device.createPipelineLayout({
            label: 'Test Pipeline Layout',
            bindGroupLayouts: [ssboBindGroupLayout],
            // WebGPU에서는 pushConstantRanges를 지원하지 않음
        });
        this.#pipeline = device.createRenderPipeline({
            label: 'Test Pipeline',
            layout: pipelineLayout,
            vertex: {
                module: shaderModule,
                entryPoint: 'vs_main',
                buffers: [VERTEX_DESC],
            },
            fragment: {
                module: shaderModule,
                entryPoint: 'fs_main',
                targets: [{ format }],
            },
            primitive: {
                topology: 'triangle-strip',
                stripIndexFormat: 'uint16',
            },
        });
        this.#combinedBuffer = createCombinedBuffer(device);
        this.#startTime = Date.now();
    }
    #updateStorageBuffer(canvasWidth, canvasHeight) {
        const now = (performance.now() - this.#startTime) / 1000.0;
        const ssbo = {
            model: mat4.create(),
            view: mat4.create(),
            proj: mat4.create(),
        };
        mat4.fromZRotation(ssbo.model, -(now * 90 * Math.PI) / 180);
        const eye = vec3.fromValues(2, 2, 2);
        const center = vec3.fromValues(0, 0, 0);
        const up = vec3.fromValues(0, 0, 1);
        mat4.lookAt(ssbo.view, eye, center, up);
        const aspect = canvasWidth / canvasHeight;
        mat4.perspective(ssbo.proj, Math.PI / 4, aspect, 0.1, 10);
        this.#device.queue.writeBuffer(this.#ssboBuffer, 0, flattenSBO(ssbo));
    }
    recordCommands(encoder, view, canvasWidth, canvasHeight) {
        const passEncoder = encoder.beginRenderPass({
            colorAttachments: [{
                    view,
                    loadOp: 'clear',
                    storeOp: 'store',
                    clearValue: CLEAR_COLOR,
                }],
        });
        passEncoder.setPipeline(this.#pipeline);
        passEncoder.setVertexBuffer(0, this.#combinedBuffer.buffer, this.#combinedBuffer.vertexOffset);
        passEncoder.setIndexBuffer(this.#combinedBuffer.buffer, 'uint16', this.#combinedBuffer.indexOffset);
        this.#updateStorageBuffer(canvasWidth, canvasHeight);
        passEncoder.setBindGroup(0, this.#ssboBindGroup);
        passEncoder.drawIndexed(this.#combinedBuffer.indexCount, 1, 0, 0, 0);
        passEncoder.end();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLXBhc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZW5kZXItcGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFVBQVUsTUFBTSx1QkFBdUIsQ0FBQztBQUUvQyxPQUFPLEVBQUUsZUFBZSxFQUFVLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNoRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDN0MsT0FBTyxFQUFFLFVBQVUsRUFBdUIsTUFBTSxRQUFRLENBQUM7QUFFekQsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7QUFFN0QsTUFBTSxhQUFhLEdBQWEsQ0FBQztRQUMvQixHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQztRQUNoQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNoQyxFQUFFO1FBQ0QsR0FBRyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDO1FBQy9CLEtBQUssRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hDLEVBQUU7UUFDRCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO1FBQzlCLEtBQUssRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hDLEVBQUU7UUFDRCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7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LENBQUM7SUFFRCxjQUFjLENBQUMsT0FBMEIsRUFBRSxJQUFvQixFQUFFLFdBQW1CLEVBQUUsWUFBb0I7UUFDeEcsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLGVBQWUsQ0FBQztZQUMxQyxnQkFBZ0IsRUFBRSxDQUFDO29CQUNqQixJQUFJO29CQUNKLE1BQU0sRUFBRSxPQUFPO29CQUNmLE9BQU8sRUFBRSxPQUFPO29CQUNoQixVQUFVLEVBQUUsV0FBVztpQkFDeEIsQ0FBQztTQUNILENBQUMsQ0FBQztRQUVILFdBQVcsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRXhDLFdBQVcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDL0YsV0FBVyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVwRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ3JELFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUVqRCxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUNwQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgU0hBREVSX1NUUiBmcm9tICcuL3NoYWRlcnMvc2hhZGVyLndnc2wnO1xuaW1wb3J0IHsgRGV2aWNlIH0gZnJvbSAnLi4vLi4vZGlzdC9kZXZpY2UuanMnO1xuaW1wb3J0IHsgZmxhdHRlblZlcnRpY2VzLCBWZXJ0ZXgsIFZFUlRFWF9ERVNDIH0gZnJvbSAnLi92ZXJ0ZXgnO1xuaW1wb3J0IHsgbWF0NCwgdmVjMiwgdmVjMyB9IGZyb20gJ2dsLW1hdHJpeCc7XG5pbXBvcnQgeyBmbGF0dGVuU0JPLCBTdG9yYWdlQnVmZmVyT2JqZWN0IH0gZnJvbSAnLi9zc2JvJztcblxuY29uc3QgQ0xFQVJfQ09MT1IgPSB7IHI6IDAuMTkyMSwgZzogMC4zMDIsIGI6IDAuNDc0NSwgYTogMSB9O1xuXG5jb25zdCBURVNUX1ZFUlRJQ0VTOiBWZXJ0ZXhbXSA9IFt7XG4gIHBvczogdmVjMi5mcm9tVmFsdWVzKC0wLjUsIC0wLjUpLFxuICBjb2xvcjogdmVjMy5mcm9tVmFsdWVzKDEsIDAsIDApLFxufSwge1xuICBwb3M6IHZlYzIuZnJvbVZhbHVlcygwLjUsIC0wLjUpLFxuICBjb2xvcjogdmVjMy5mcm9tVmFsdWVzKDAsIDEsIDApLFxufSwge1xuICBwb3M6IHZlYzIuZnJvbVZhbHVlcygwLjUsIDAuNSksXG4gIGNvbG9yOiB2ZWMzLmZyb21WYWx1ZXMoMCwgMCwgMSksXG59LCB7XG4gIHBvczogdmVjMi5mcm9tVmFsdWVzKC0wLjUsIDAuNSksXG4gIGNvbG9yOiB2ZWMzLmZyb21WYWx1ZXMoMSwgMSwgMSksXG59XTtcblxuY29uc3QgVEVTVF9JTkRJQ0VTOiBudW1iZXJbXSA9IFswLCAxLCAyLCAyLCAzLCAwXTtcblxuaW50ZXJmYWNlIENvbWJpbmVkQnVmZmVyIHtcbiAgYnVmZmVyOiBHUFVCdWZmZXI7XG4gIHZlcnRleE9mZnNldDogbnVtYmVyO1xuICBpbmRleE9mZnNldDogbnVtYmVyO1xuICBpbmRleENvdW50OiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUNvbWJpbmVkQnVmZmVyKGRldmljZTogRGV2aWNlKTogQ29tYmluZWRCdWZmZXIge1xuICBjb25zdCBmbGF0VmVydGV4RGF0YSA9IGZsYXR0ZW5WZXJ0aWNlcyhURVNUX1ZFUlRJQ0VTKTtcbiAgY29uc3QgdmVydGV4RmxvYXRMZW5ndGggPSBmbGF0VmVydGV4RGF0YS5sZW5ndGg7XG4gIGNvbnN0IHZlcnRleFNpemUgPSB2ZXJ0ZXhGbG9hdExlbmd0aCAqIDQ7XG4gIGNvbnN0IGluZGV4Q291bnQgPSBURVNUX0lORElDRVMubGVuZ3RoO1xuICBjb25zdCBpbmRleFNpemUgPSBpbmRleENvdW50ICogMjtcblxuICBjb25zdCBpbmRleE9mZnNldCA9ICh2ZXJ0ZXhTaXplICsgMykgJiB+MzsgLy8gNC1ieXRlIGFsaWdubWVudFxuICBjb25zdCB0b3RhbFNpemUgPSBpbmRleE9mZnNldCArIGluZGV4U2l6ZTtcblxuICBjb25zdCBidWZmZXIgPSBkZXZpY2UuY3JlYXRlQnVmZmVyKHtcbiAgICBsYWJlbDogJ1Rlc3QgQnVmZmVyJyxcbiAgICBzaXplOiB0b3RhbFNpemUsXG4gICAgdXNhZ2U6IEdQVUJ1ZmZlclVzYWdlLlZFUlRFWCB8IEdQVUJ1ZmZlclVzYWdlLklOREVYIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9EU1QsXG4gICAgbWFwcGVkQXRDcmVhdGlvbjogdHJ1ZSxcbiAgfSk7XG5cbiAgY29uc3QgbWFwcGluZyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlci5nZXRNYXBwZWRSYW5nZSgpKTtcbiAgbmV3IEZsb2F0MzJBcnJheShtYXBwaW5nLmJ1ZmZlcikuc2V0KGZsYXRWZXJ0ZXhEYXRhKTtcbiAgbmV3IFVpbnQxNkFycmF5KG1hcHBpbmcuYnVmZmVyLCBpbmRleE9mZnNldCwgaW5kZXhDb3VudCkuc2V0KFRFU1RfSU5ESUNFUyk7XG4gIGJ1ZmZlci51bm1hcCgpO1xuXG4gIHJldHVybiB7XG4gICAgYnVmZmVyLFxuICAgIHZlcnRleE9mZnNldDogMCxcbiAgICBpbmRleE9mZnNldCxcbiAgICBpbmRleENvdW50LFxuICB9O1xufVxuXG5cbmV4cG9ydCBjbGFzcyBUZXN0UmVuZGVyUGFzcyB7XG4gICNkZXZpY2U6IERldmljZTtcbiAgI3BpcGVsaW5lOiBHUFVSZW5kZXJQaXBlbGluZTtcbiAgI2NvbWJpbmVkQnVmZmVyOiBDb21iaW5lZEJ1ZmZlcjtcbiAgI3NzYm9CdWZmZXI6IEdQVUJ1ZmZlcjtcbiAgI3NzYm9CaW5kR3JvdXA6IEdQVUJpbmRHcm91cDtcbiAgI3N0YXJ0VGltZTogbnVtYmVyO1xuXG4gIGNvbnN0cnVjdG9yKGRldmljZTogRGV2aWNlLCBmb3JtYXQ6IEdQVVRleHR1cmVGb3JtYXQpIHtcbiAgICB0aGlzLiNkZXZpY2UgPSBkZXZpY2U7XG5cbiAgICBsZXQgc2hhZGVyTW9kdWxlID0gZGV2aWNlLmNyZWF0ZVNoYWRlck1vZHVsZSh7IGxhYmVsOiAnVGVzdCBTaGFkZXInLCBjb2RlOiBTSEFERVJfU1RSIH0pO1xuXG4gICAgY29uc3QgbWF0NFNpemUgPSA0ICogNCAqIDQ7IC8vIDR4NCBmbG9hdDMyID0gMTYgZmxvYXRzICogNCBieXRlcyA9IDY0IGJ5dGVzXG4gICAgY29uc3Qgc3Nib1NpemUgPSBtYXQ0U2l6ZSAqIDM7IC8vIG1vZGVsICsgdmlldyArIHByb2ogPSAzICogNjQgPSAxOTIgYnl0ZXNcblxuICAgIHRoaXMuI3NzYm9CdWZmZXIgPSBkZXZpY2UuY3JlYXRlQnVmZmVyKHtcbiAgICAgIGxhYmVsOiAnU1NCTyBCdWZmZXInLFxuICAgICAgc2l6ZTogc3Nib1NpemUsXG4gICAgICB1c2FnZTogR1BVQnVmZmVyVXNhZ2UuU1RPUkFHRSB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNULFxuICAgIH0pO1xuXG4gICAgY29uc3Qgc3Nib0JpbmRHcm91cExheW91dCA9IGRldmljZS5jcmVhdGVCaW5kR3JvdXBMYXlvdXQoe1xuICAgICAgbGFiZWw6ICdTQk8gQmluZCBHcm91cCBMYXlvdXQnLFxuICAgICAgZW50cmllczogW3tcbiAgICAgICAgYmluZGluZzogMCxcbiAgICAgICAgdmlzaWJpbGl0eTogR1BVU2hhZGVyU3RhZ2UuVkVSVEVYLFxuICAgICAgICBidWZmZXI6IHsgdHlwZTogJ3JlYWQtb25seS1zdG9yYWdlJyB9LFxuICAgICAgfV0sXG4gICAgfSk7XG5cbiAgICB0aGlzLiNzc2JvQmluZEdyb3VwID0gZGV2aWNlLmNyZWF0ZUJpbmRHcm91cCh7XG4gICAgICBsYWJlbDogJ1NCTyBCaW5kIEdyb3VwJyxcbiAgICAgIGxheW91dDogc3Nib0JpbmRHcm91cExheW91dCxcbiAgICAgIGVudHJpZXM6IFt7XG4gICAgICAgIGJpbmRpbmc6IDAsXG4gICAgICAgIHJlc291cmNlOiB7IGJ1ZmZlcjogdGhpcy4jc3Nib0J1ZmZlciB9LFxuICAgICAgfV0sXG4gICAgfSk7XG5cbiAgICBsZXQgcGlwZWxpbmVMYXlvdXQgPSBkZXZpY2UuY3JlYXRlUGlwZWxpbmVMYXlvdXQoe1xuICAgICAgbGFiZWw6ICdUZXN0IFBpcGVsaW5lIExheW91dCcsXG4gICAgICBiaW5kR3JvdXBMYXlvdXRzOiBbc3Nib0JpbmRHcm91cExheW91dF0sXG4gICAgICAvLyBXZWJHUFXsl5DshJzripQgcHVzaENvbnN0YW50UmFuZ2Vz66W8IOyngOybkO2VmOyngCDslYrsnYxcbiAgICB9KTtcblxuICAgIHRoaXMuI3BpcGVsaW5lID0gZGV2aWNlLmNyZWF0ZVJlbmRlclBpcGVsaW5lKHtcbiAgICAgIGxhYmVsOiAnVGVzdCBQaXBlbGluZScsXG4gICAgICBsYXlvdXQ6IHBpcGVsaW5lTGF5b3V0LFxuICAgICAgdmVydGV4OiB7XG4gICAgICAgIG1vZHVsZTogc2hhZGVyTW9kdWxlLFxuICAgICAgICBlbnRyeVBvaW50OiAndnNfbWFpbicsXG4gICAgICAgIGJ1ZmZlcnM6IFtWRVJURVhfREVTQ10sXG4gICAgICB9LFxuICAgICAgZnJhZ21lbnQ6IHtcbiAgICAgICAgbW9kdWxlOiBzaGFkZXJNb2R1bGUsXG4gICAgICAgIGVudHJ5UG9pbnQ6ICdmc19tYWluJyxcbiAgICAgICAgdGFyZ2V0czogW3sgZm9ybWF0IH1dLFxuICAgICAgfSxcbiAgICAgIHByaW1pdGl2ZToge1xuICAgICAgICB0b3BvbG9neTogJ3RyaWFuZ2xlLXN0cmlwJyxcbiAgICAgICAgc3RyaXBJbmRleEZvcm1hdDogJ3VpbnQxNicsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy4jY29tYmluZWRCdWZmZXIgPSBjcmVhdGVDb21iaW5lZEJ1ZmZlcihkZXZpY2UpO1xuICAgIHRoaXMuI3N0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gIH1cblxuICAjdXBkYXRlU3RvcmFnZUJ1ZmZlcihjYW52YXNXaWR0aDogbnVtYmVyLCBjYW52YXNIZWlnaHQ6IG51bWJlcikge1xuICAgIGNvbnN0IG5vdyA9IChwZXJmb3JtYW5jZS5ub3coKSAtIHRoaXMuI3N0YXJ0VGltZSkgLyAxMDAwLjA7XG5cbiAgICBjb25zdCBzc2JvOiBTdG9yYWdlQnVmZmVyT2JqZWN0ID0ge1xuICAgICAgbW9kZWw6IG1hdDQuY3JlYXRlKCksXG4gICAgICB2aWV3OiBtYXQ0LmNyZWF0ZSgpLFxuICAgICAgcHJvajogbWF0NC5jcmVhdGUoKSxcbiAgICB9O1xuXG4gICAgbWF0NC5mcm9tWlJvdGF0aW9uKHNzYm8ubW9kZWwsIC0obm93ICogOTAgKiBNYXRoLlBJKSAvIDE4MCk7XG5cbiAgICBjb25zdCBleWUgPSB2ZWMzLmZyb21WYWx1ZXMoMiwgMiwgMik7XG4gICAgY29uc3QgY2VudGVyID0gdmVjMy5mcm9tVmFsdWVzKDAsIDAsIDApO1xuICAgIGNvbnN0IHVwID0gdmVjMy5mcm9tVmFsdWVzKDAsIDAsIDEpO1xuICAgIG1hdDQubG9va0F0KHNzYm8udmlldywgZXllLCBjZW50ZXIsIHVwKTtcblxuICAgIGNvbnN0IGFzcGVjdCA9IGNhbnZhc1dpZHRoIC8gY2FudmFzSGVpZ2h0O1xuICAgIG1hdDQucGVyc3BlY3RpdmUoc3Niby5wcm9qLCBNYXRoLlBJIC8gNCwgYXNwZWN0LCAwLjEsIDEwKTtcblxuICAgIHRoaXMuI2RldmljZS5xdWV1ZS53cml0ZUJ1ZmZlcih0aGlzLiNzc2JvQnVmZmVyLCAwLCBmbGF0dGVuU0JPKHNzYm8pKTtcbiAgfVxuXG4gIHJlY29yZENvbW1hbmRzKGVuY29kZXI6IEdQVUNvbW1hbmRFbmNvZGVyLCB2aWV3OiBHUFVUZXh0dXJlVmlldywgY2FudmFzV2lkdGg6IG51bWJlciwgY2FudmFzSGVpZ2h0OiBudW1iZXIpIHtcbiAgICBjb25zdCBwYXNzRW5jb2RlciA9IGVuY29kZXIuYmVnaW5SZW5kZXJQYXNzKHtcbiAgICAgIGNvbG9yQXR0YWNobWVudHM6IFt7XG4gICAgICAgIHZpZXcsXG4gICAgICAgIGxvYWRPcDogJ2NsZWFyJyxcbiAgICAgICAgc3RvcmVPcDogJ3N0b3JlJyxcbiAgICAgICAgY2xlYXJWYWx1ZTogQ0xFQVJfQ09MT1IsXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIHBhc3NFbmNvZGVyLnNldFBpcGVsaW5lKHRoaXMuI3BpcGVsaW5lKTtcblxuICAgIHBhc3NFbmNvZGVyLnNldFZlcnRleEJ1ZmZlcigwLCB0aGlzLiNjb21iaW5lZEJ1ZmZlci5idWZmZXIsIHRoaXMuI2NvbWJpbmVkQnVmZmVyLnZlcnRleE9mZnNldCk7XG4gICAgcGFzc0VuY29kZXIuc2V0SW5kZXhCdWZmZXIodGhpcy4jY29tYmluZWRCdWZmZXIuYnVmZmVyLCAndWludDE2JywgdGhpcy4jY29tYmluZWRCdWZmZXIuaW5kZXhPZmZzZXQpO1xuXG4gICAgdGhpcy4jdXBkYXRlU3RvcmFnZUJ1ZmZlcihjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0KTtcbiAgICBwYXNzRW5jb2Rlci5zZXRCaW5kR3JvdXAoMCwgdGhpcy4jc3Nib0JpbmRHcm91cCk7XG5cbiAgICBwYXNzRW5jb2Rlci5kcmF3SW5kZXhlZCh0aGlzLiNjb21iaW5lZEJ1ZmZlci5pbmRleENvdW50LCAxLCAwLCAwLCAwKTtcbiAgICBwYXNzRW5jb2Rlci5lbmQoKTtcbiAgfVxufVxuIl19