import SHADER_STR from './shaders/shader.wgsl';
import { flattenVertices, VERTEX_DESC } from './vertex';
import { mat4, vec2, vec3 } from 'gl-matrix';
import { flattenUBO } from './ubo';
const CLEAR_COLOR = { r: 0.1921, g: 0.302, b: 0.4745, a: 1 };
const TEST_VERTICES = [{
        pos: vec2.fromValues(-0.5, -0.5),
        color: vec3.fromValues(1, 0, 0),
    }, {
        pos: vec2.fromValues(0.5, -0.5),
        color: vec3.fromValues(0, 1, 0),
    }, {
        pos: vec2.fromValues(0.5, 0.5),
        color: vec3.fromValues(0, 0, 1),
    }, {
        pos: vec2.fromValues(-0.5, 0.5),
        color: vec3.fromValues(1, 1, 1),
    }];
const TEST_INDICES = [0, 1, 2, 2, 3, 0];
function createCombinedBuffer(device) {
    const flatVertexData = flattenVertices(TEST_VERTICES);
    const vertexFloatLength = flatVertexData.length;
    const vertexSize = vertexFloatLength * 4;
    const indexCount = TEST_INDICES.length;
    const indexSize = indexCount * 2;
    const indexOffset = (vertexSize + 3) & ~3; // 4-byte alignment
    const totalSize = indexOffset + indexSize;
    const buffer = device.createBuffer({
        label: 'Test Buffer',
        size: totalSize,
        usage: GPUBufferUsage.VERTEX | GPUBufferUsage.INDEX | GPUBufferUsage.COPY_DST,
        mappedAtCreation: true,
    });
    const mapping = new Uint8Array(buffer.getMappedRange());
    new Float32Array(mapping.buffer).set(flatVertexData);
    new Uint16Array(mapping.buffer, indexOffset, indexCount).set(TEST_INDICES);
    buffer.unmap();
    return {
        buffer,
        vertexOffset: 0,
        indexOffset,
        indexCount,
    };
}
export class TestRenderPass {
    #device;
    #pipeline;
    #combinedBuffer;
    #uboBuffer;
    #uboBindGroup;
    #startTime;
    constructor(device, format) {
        this.#device = device;
        let shaderModule = device.createShaderModule({ label: 'Test Shader', code: SHADER_STR });
        const mat4Size = 4 * 4 * 4; // 4x4 float32 = 16 floats * 4 bytes = 64 bytes
        const uboSize = mat4Size * 3; // model + view + proj = 3 * 64 = 192 bytes
        this.#uboBuffer = device.createBuffer({
            label: 'UBO Buffer',
            size: uboSize,
            usage: GPUBufferUsage.UNIFORM | GPUBufferUsage.COPY_DST,
        });
        const uboBindGroupLayout = device.createBindGroupLayout({
            label: 'UBO Bind Group Layout',
            entries: [{
                    binding: 0,
                    visibility: GPUShaderStage.VERTEX,
                    buffer: { type: 'uniform' },
                }],
        });
        this.#uboBindGroup = device.createBindGroup({
            label: 'UBO Bind Group',
            layout: uboBindGroupLayout,
            entries: [{
                    binding: 0,
                    resource: { buffer: this.#uboBuffer },
                }],
        });
        let pipelineLayout = device.createPipelineLayout({
            label: 'Test Pipeline Layout',
            bindGroupLayouts: [uboBindGroupLayout],
            // WebGPU에서는 pushConstantRanges를 지원하지 않음
        });
        this.#pipeline = device.createRenderPipeline({
            label: 'Test Pipeline',
            layout: pipelineLayout,
            vertex: {
                module: shaderModule,
                entryPoint: 'vs_main',
                buffers: [VERTEX_DESC],
            },
            fragment: {
                module: shaderModule,
                entryPoint: 'fs_main',
                targets: [{ format }],
            },
            primitive: {
                topology: 'triangle-strip',
                stripIndexFormat: 'uint16',
            },
        });
        this.#combinedBuffer = createCombinedBuffer(device);
        this.#startTime = Date.now();
    }
    #updateUniformBuffer(canvasWidth, canvasHeight) {
        const now = (performance.now() - this.#startTime) / 1000.0;
        const ubo = {
            model: mat4.create(),
            view: mat4.create(),
            proj: mat4.create(),
        };
        mat4.fromZRotation(ubo.model, -(now * 90 * Math.PI) / 180);
        const eye = vec3.fromValues(2, 2, 2);
        const center = vec3.fromValues(0, 0, 0);
        const up = vec3.fromValues(0, 0, 1);
        mat4.lookAt(ubo.view, eye, center, up);
        const aspect = canvasWidth / canvasHeight;
        mat4.perspective(ubo.proj, Math.PI / 4, aspect, 0.1, 10);
        this.#device.queue.writeBuffer(this.#uboBuffer, 0, flattenUBO(ubo));
    }
    recordCommands(encoder, view, canvasWidth, canvasHeight) {
        const passEncoder = encoder.beginRenderPass({
            colorAttachments: [{
                    view,
                    loadOp: 'clear',
                    storeOp: 'store',
                    clearValue: CLEAR_COLOR,
                }],
        });
        passEncoder.setPipeline(this.#pipeline);
        passEncoder.setVertexBuffer(0, this.#combinedBuffer.buffer, this.#combinedBuffer.vertexOffset);
        passEncoder.setIndexBuffer(this.#combinedBuffer.buffer, 'uint16', this.#combinedBuffer.indexOffset);
        this.#updateUniformBuffer(canvasWidth, canvasHeight);
        passEncoder.setBindGroup(0, this.#uboBindGroup);
        passEncoder.drawIndexed(this.#combinedBuffer.indexCount, 1, 0, 0, 0);
        passEncoder.end();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVuZGVyLXBhc3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZW5kZXItcGFzcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLFVBQVUsTUFBTSx1QkFBdUIsQ0FBQztBQUUvQyxPQUFPLEVBQUUsZUFBZSxFQUFVLFdBQVcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUNoRSxPQUFPLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDN0MsT0FBTyxFQUFFLFVBQVUsRUFBdUIsTUFBTSxPQUFPLENBQUM7QUFFeEQsTUFBTSxXQUFXLEdBQUcsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUM7QUFFN0QsTUFBTSxhQUFhLEdBQWEsQ0FBQztRQUMvQixHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLEdBQUcsQ0FBQztRQUNoQyxLQUFLLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNoQyxFQUFFO1FBQ0QsR0FBRyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsR0FBRyxDQUFDO1FBQy9CLEtBQUssRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hDLEVBQUU7UUFDRCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDO1FBQzlCLEtBQUssRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0tBQ2hDLEVBQUU7UUFDRCxHQUFHLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUM7UUFDL0IsS0FBSyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7S0FDaEMsQ0FBQyxDQUFDO0FBRUgsTUFBTSxZQUFZLEdBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBU2xELFNBQVMsb0JBQW9CLENBQUMsTUFBYztJQUMxQyxNQUFNLGNBQWMsR0FBRyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdEQsTUFBTSxpQkFBaUIsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDO0lBQ2hELE1BQU0sVUFBVSxHQUFHLGlCQUFpQixHQUFHLENBQUMsQ0FBQztJQUN6QyxNQUFNLFVBQVUsR0FBRyxZQUFZLENBQUMsTUFBTSxDQUFDO0lBQ3ZDLE1BQU0sU0FBUyxHQUFHLFVBQVUsR0FBRyxDQUFDLENBQUM7SUFFakMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxtQkFBbUI7SUFDOUQsTUFBTSxTQUFTLEdBQUcsV0FBVyxHQUFHLFNBQVMsQ0FBQztJQUUxQyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO1FBQ2pDLEtBQUssRUFBRSxhQUFhO1FBQ3BCLElBQUksRUFBRSxTQUFTO1FBQ2YsS0FBSyxFQUFFLGNBQWMsQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDLEtBQUssR0FBRyxjQUFjLENBQUMsUUFBUTtRQUM3RSxnQkFBZ0IsRUFBRSxJQUFJO0tBQ3ZCLENBQUMsQ0FBQztJQUVILE1BQU0sT0FBTyxHQUFHLElBQUksVUFBVSxDQUFDLE1BQU0sQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO0lBQ3hELElBQUksWUFBWSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDckQsSUFBSSxXQUFXLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQzNFLE1BQU0sQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUVmLE9BQU87UUFDTCxNQUFNO1FBQ04sWUFBWSxFQUFFLENBQUM7UUFDZixXQUFXO1FBQ1gsVUFBVTtLQUNYLENBQUM7QUFDSixDQUFDO0FBR0QsTUFBTSxPQUFPLGNBQWM7SUFDekIsT0FBTyxDQUFTO0lBQ2hCLFNBQVMsQ0FBb0I7SUFDN0IsZUFBZSxDQUFpQjtJQUNoQyxVQUFVLENBQVk7SUFDdEIsYUFBYSxDQUFlO0lBQzVCLFVBQVUsQ0FBUztJQUVuQixZQUFZLE1BQWMsRUFBRSxNQUF3QjtRQUNsRCxJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUV0QixJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsa0JBQWtCLENBQUMsRUFBRSxLQUFLLEVBQUUsYUFBYSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUUsQ0FBQyxDQUFDO1FBRXpGLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsK0NBQStDO1FBQzNFLE1BQU0sT0FBTyxHQUFHLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQywyQ0FBMkM7UUFFekUsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsWUFBWSxDQUFDO1lBQ3BDLEtBQUssRUFBRSxZQUFZO1lBQ25CLElBQUksRUFBRSxPQUFPO1lBQ2IsS0FBSyxFQUFFLGNBQWMsQ0FBQyxPQUFPLEdBQUcsY0FBYyxDQUFDLFFBQVE7U0FDeEQsQ0FBQyxDQUFDO1FBRUgsTUFBTSxrQkFBa0IsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUM7WUFDdEQsS0FBSyxFQUFFLHVCQUF1QjtZQUM5QixPQUFPLEVBQUUsQ0FBQztvQkFDUixPQUFPLEVBQUUsQ0FBQztvQkFDVixVQUFVLEVBQUUsY0FBYyxDQUFDLE1BQU07b0JBQ2pDLE1BQU0sRUFBRSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUU7aUJBQzVCLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsYUFBYSxHQUFHLE1BQU0sQ0FBQyxlQUFlLENBQUM7WUFDMUMsS0FBSyxFQUFFLGdCQUFnQjtZQUN2QixNQUFNLEVBQUUsa0JBQWtCO1lBQzFCLE9BQU8sRUFBRSxDQUFDO29CQUNSLE9BQU8sRUFBRSxDQUFDO29CQUNWLFFBQVEsRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFO2lCQUN0QyxDQUFDO1NBQ0gsQ0FBQyxDQUFDO1FBRUgsSUFBSSxjQUFjLEdBQUcsTUFBTSxDQUFDLG9CQUFvQixDQUFDO1lBQy9DLEtBQUssRUFBRSxzQkFBc0I7WUFDN0IsZ0JBQWdCLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQztZQUN0Qyx3Q0FBd0M7U0FDekMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLFNBQVMsR0FBRyxNQUFNLENBQUMsb0JBQW9CLENBQUM7WUFDM0MsS0FBSyxFQUFFLGVBQWU7WUFDdEIsTUFBTSxFQUFFLGNBQWM7WUFDdEIsTUFBTSxFQUFFO2dCQUNOLE1BQU0sRUFBRSxZQUFZO2dCQUNwQixVQUFVLEVBQUUsU0FBUztnQkFDckIsT0FBTyxFQUFFLENBQUMsV0FBVyxDQUFDO2FBQ3ZCO1lBQ0QsUUFBUSxFQUFFO2dCQUNSLE1BQU0sRUFBRSxZQUFZO2dCQUNwQixVQUFVLEVBQUUsU0FBUztnQkFDckIsT0FBTyxFQUFFLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQzthQUN0QjtZQUNELFNBQVMsRUFBRTtnQkFDVCxRQUFRLEVBQUUsZ0JBQWdCO2dCQUMxQixnQkFBZ0IsRUFBRSxRQUFRO2FBQzNCO1NBQ0YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGVBQWUsR0FBRyxvQkFBb0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRUQsb0JBQW9CLENBQUMsV0FBbUIsRUFBRSxZQUFvQjtRQUM1RCxNQUFNLEdBQUcsR0FBRyxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsTUFBTSxDQUFDO1FBRTNELE1BQU0sR0FBRyxHQUF3QjtZQUMvQixLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNwQixJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNuQixJQUFJLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRTtTQUNwQixDQUFDO1FBRUYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxHQUFHLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQztRQUUzRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDckMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNwQyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxFQUFFLENBQUMsQ0FBQztRQUV2QyxNQUFNLE1BQU0sR0FBRyxXQUFXLEdBQUcsWUFBWSxDQUFDO1FBQzFDLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxHQUFHLENBQUMsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXpELElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsRUFBRSxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN0RSxDQUFDO0lBRUQsY0FBYyxDQUFDLE9BQTBCLEVBQUUsSUFBb0IsRUFBRSxXQUFtQixFQUFFLFlBQW9CO1FBQ3hHLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxlQUFlLENBQUM7WUFDMUMsZ0JBQWdCLEVBQUUsQ0FBQztvQkFDakIsSUFBSTtvQkFDSixNQUFNLEVBQUUsT0FBTztvQkFDZixPQUFPLEVBQUUsT0FBTztvQkFDaEIsVUFBVSxFQUFFLFdBQVc7aUJBQ3hCLENBQUM7U0FDSCxDQUFDLENBQUM7UUFFSCxXQUFXLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUV4QyxXQUFXLENBQUMsZUFBZSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQy9GLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7UUFFcEcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFdBQVcsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNyRCxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFaEQsV0FBVyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUNyRSxXQUFXLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDcEIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNIQURFUl9TVFIgZnJvbSAnLi9zaGFkZXJzL3NoYWRlci53Z3NsJztcbmltcG9ydCB7IERldmljZSB9IGZyb20gJy4uLy4uL2Rpc3QvZGV2aWNlLmpzJztcbmltcG9ydCB7IGZsYXR0ZW5WZXJ0aWNlcywgVmVydGV4LCBWRVJURVhfREVTQyB9IGZyb20gJy4vdmVydGV4JztcbmltcG9ydCB7IG1hdDQsIHZlYzIsIHZlYzMgfSBmcm9tICdnbC1tYXRyaXgnO1xuaW1wb3J0IHsgZmxhdHRlblVCTywgVW5pZm9ybUJ1ZmZlck9iamVjdCB9IGZyb20gJy4vdWJvJztcblxuY29uc3QgQ0xFQVJfQ09MT1IgPSB7IHI6IDAuMTkyMSwgZzogMC4zMDIsIGI6IDAuNDc0NSwgYTogMSB9O1xuXG5jb25zdCBURVNUX1ZFUlRJQ0VTOiBWZXJ0ZXhbXSA9IFt7XG4gIHBvczogdmVjMi5mcm9tVmFsdWVzKC0wLjUsIC0wLjUpLFxuICBjb2xvcjogdmVjMy5mcm9tVmFsdWVzKDEsIDAsIDApLFxufSwge1xuICBwb3M6IHZlYzIuZnJvbVZhbHVlcygwLjUsIC0wLjUpLFxuICBjb2xvcjogdmVjMy5mcm9tVmFsdWVzKDAsIDEsIDApLFxufSwge1xuICBwb3M6IHZlYzIuZnJvbVZhbHVlcygwLjUsIDAuNSksXG4gIGNvbG9yOiB2ZWMzLmZyb21WYWx1ZXMoMCwgMCwgMSksXG59LCB7XG4gIHBvczogdmVjMi5mcm9tVmFsdWVzKC0wLjUsIDAuNSksXG4gIGNvbG9yOiB2ZWMzLmZyb21WYWx1ZXMoMSwgMSwgMSksXG59XTtcblxuY29uc3QgVEVTVF9JTkRJQ0VTOiBudW1iZXJbXSA9IFswLCAxLCAyLCAyLCAzLCAwXTtcblxuaW50ZXJmYWNlIENvbWJpbmVkQnVmZmVyIHtcbiAgYnVmZmVyOiBHUFVCdWZmZXI7XG4gIHZlcnRleE9mZnNldDogbnVtYmVyO1xuICBpbmRleE9mZnNldDogbnVtYmVyO1xuICBpbmRleENvdW50OiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUNvbWJpbmVkQnVmZmVyKGRldmljZTogRGV2aWNlKTogQ29tYmluZWRCdWZmZXIge1xuICBjb25zdCBmbGF0VmVydGV4RGF0YSA9IGZsYXR0ZW5WZXJ0aWNlcyhURVNUX1ZFUlRJQ0VTKTtcbiAgY29uc3QgdmVydGV4RmxvYXRMZW5ndGggPSBmbGF0VmVydGV4RGF0YS5sZW5ndGg7XG4gIGNvbnN0IHZlcnRleFNpemUgPSB2ZXJ0ZXhGbG9hdExlbmd0aCAqIDQ7XG4gIGNvbnN0IGluZGV4Q291bnQgPSBURVNUX0lORElDRVMubGVuZ3RoO1xuICBjb25zdCBpbmRleFNpemUgPSBpbmRleENvdW50ICogMjtcblxuICBjb25zdCBpbmRleE9mZnNldCA9ICh2ZXJ0ZXhTaXplICsgMykgJiB+MzsgLy8gNC1ieXRlIGFsaWdubWVudFxuICBjb25zdCB0b3RhbFNpemUgPSBpbmRleE9mZnNldCArIGluZGV4U2l6ZTtcblxuICBjb25zdCBidWZmZXIgPSBkZXZpY2UuY3JlYXRlQnVmZmVyKHtcbiAgICBsYWJlbDogJ1Rlc3QgQnVmZmVyJyxcbiAgICBzaXplOiB0b3RhbFNpemUsXG4gICAgdXNhZ2U6IEdQVUJ1ZmZlclVzYWdlLlZFUlRFWCB8IEdQVUJ1ZmZlclVzYWdlLklOREVYIHwgR1BVQnVmZmVyVXNhZ2UuQ09QWV9EU1QsXG4gICAgbWFwcGVkQXRDcmVhdGlvbjogdHJ1ZSxcbiAgfSk7XG5cbiAgY29uc3QgbWFwcGluZyA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlci5nZXRNYXBwZWRSYW5nZSgpKTtcbiAgbmV3IEZsb2F0MzJBcnJheShtYXBwaW5nLmJ1ZmZlcikuc2V0KGZsYXRWZXJ0ZXhEYXRhKTtcbiAgbmV3IFVpbnQxNkFycmF5KG1hcHBpbmcuYnVmZmVyLCBpbmRleE9mZnNldCwgaW5kZXhDb3VudCkuc2V0KFRFU1RfSU5ESUNFUyk7XG4gIGJ1ZmZlci51bm1hcCgpO1xuXG4gIHJldHVybiB7XG4gICAgYnVmZmVyLFxuICAgIHZlcnRleE9mZnNldDogMCxcbiAgICBpbmRleE9mZnNldCxcbiAgICBpbmRleENvdW50LFxuICB9O1xufVxuXG5cbmV4cG9ydCBjbGFzcyBUZXN0UmVuZGVyUGFzcyB7XG4gICNkZXZpY2U6IERldmljZTtcbiAgI3BpcGVsaW5lOiBHUFVSZW5kZXJQaXBlbGluZTtcbiAgI2NvbWJpbmVkQnVmZmVyOiBDb21iaW5lZEJ1ZmZlcjtcbiAgI3Vib0J1ZmZlcjogR1BVQnVmZmVyO1xuICAjdWJvQmluZEdyb3VwOiBHUFVCaW5kR3JvdXA7XG4gICNzdGFydFRpbWU6IG51bWJlcjtcblxuICBjb25zdHJ1Y3RvcihkZXZpY2U6IERldmljZSwgZm9ybWF0OiBHUFVUZXh0dXJlRm9ybWF0KSB7XG4gICAgdGhpcy4jZGV2aWNlID0gZGV2aWNlO1xuXG4gICAgbGV0IHNoYWRlck1vZHVsZSA9IGRldmljZS5jcmVhdGVTaGFkZXJNb2R1bGUoeyBsYWJlbDogJ1Rlc3QgU2hhZGVyJywgY29kZTogU0hBREVSX1NUUiB9KTtcblxuICAgIGNvbnN0IG1hdDRTaXplID0gNCAqIDQgKiA0OyAvLyA0eDQgZmxvYXQzMiA9IDE2IGZsb2F0cyAqIDQgYnl0ZXMgPSA2NCBieXRlc1xuICAgIGNvbnN0IHVib1NpemUgPSBtYXQ0U2l6ZSAqIDM7IC8vIG1vZGVsICsgdmlldyArIHByb2ogPSAzICogNjQgPSAxOTIgYnl0ZXNcblxuICAgIHRoaXMuI3Vib0J1ZmZlciA9IGRldmljZS5jcmVhdGVCdWZmZXIoe1xuICAgICAgbGFiZWw6ICdVQk8gQnVmZmVyJyxcbiAgICAgIHNpemU6IHVib1NpemUsXG4gICAgICB1c2FnZTogR1BVQnVmZmVyVXNhZ2UuVU5JRk9STSB8IEdQVUJ1ZmZlclVzYWdlLkNPUFlfRFNULFxuICAgIH0pO1xuXG4gICAgY29uc3QgdWJvQmluZEdyb3VwTGF5b3V0ID0gZGV2aWNlLmNyZWF0ZUJpbmRHcm91cExheW91dCh7XG4gICAgICBsYWJlbDogJ1VCTyBCaW5kIEdyb3VwIExheW91dCcsXG4gICAgICBlbnRyaWVzOiBbe1xuICAgICAgICBiaW5kaW5nOiAwLFxuICAgICAgICB2aXNpYmlsaXR5OiBHUFVTaGFkZXJTdGFnZS5WRVJURVgsXG4gICAgICAgIGJ1ZmZlcjogeyB0eXBlOiAndW5pZm9ybScgfSxcbiAgICAgIH1dLFxuICAgIH0pO1xuXG4gICAgdGhpcy4jdWJvQmluZEdyb3VwID0gZGV2aWNlLmNyZWF0ZUJpbmRHcm91cCh7XG4gICAgICBsYWJlbDogJ1VCTyBCaW5kIEdyb3VwJyxcbiAgICAgIGxheW91dDogdWJvQmluZEdyb3VwTGF5b3V0LFxuICAgICAgZW50cmllczogW3tcbiAgICAgICAgYmluZGluZzogMCxcbiAgICAgICAgcmVzb3VyY2U6IHsgYnVmZmVyOiB0aGlzLiN1Ym9CdWZmZXIgfSxcbiAgICAgIH1dLFxuICAgIH0pO1xuXG4gICAgbGV0IHBpcGVsaW5lTGF5b3V0ID0gZGV2aWNlLmNyZWF0ZVBpcGVsaW5lTGF5b3V0KHtcbiAgICAgIGxhYmVsOiAnVGVzdCBQaXBlbGluZSBMYXlvdXQnLFxuICAgICAgYmluZEdyb3VwTGF5b3V0czogW3Vib0JpbmRHcm91cExheW91dF0sXG4gICAgICAvLyBXZWJHUFXsl5DshJzripQgcHVzaENvbnN0YW50UmFuZ2Vz66W8IOyngOybkO2VmOyngCDslYrsnYxcbiAgICB9KTtcblxuICAgIHRoaXMuI3BpcGVsaW5lID0gZGV2aWNlLmNyZWF0ZVJlbmRlclBpcGVsaW5lKHtcbiAgICAgIGxhYmVsOiAnVGVzdCBQaXBlbGluZScsXG4gICAgICBsYXlvdXQ6IHBpcGVsaW5lTGF5b3V0LFxuICAgICAgdmVydGV4OiB7XG4gICAgICAgIG1vZHVsZTogc2hhZGVyTW9kdWxlLFxuICAgICAgICBlbnRyeVBvaW50OiAndnNfbWFpbicsXG4gICAgICAgIGJ1ZmZlcnM6IFtWRVJURVhfREVTQ10sXG4gICAgICB9LFxuICAgICAgZnJhZ21lbnQ6IHtcbiAgICAgICAgbW9kdWxlOiBzaGFkZXJNb2R1bGUsXG4gICAgICAgIGVudHJ5UG9pbnQ6ICdmc19tYWluJyxcbiAgICAgICAgdGFyZ2V0czogW3sgZm9ybWF0IH1dLFxuICAgICAgfSxcbiAgICAgIHByaW1pdGl2ZToge1xuICAgICAgICB0b3BvbG9neTogJ3RyaWFuZ2xlLXN0cmlwJyxcbiAgICAgICAgc3RyaXBJbmRleEZvcm1hdDogJ3VpbnQxNicsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgdGhpcy4jY29tYmluZWRCdWZmZXIgPSBjcmVhdGVDb21iaW5lZEJ1ZmZlcihkZXZpY2UpO1xuICAgIHRoaXMuI3N0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gIH1cblxuICAjdXBkYXRlVW5pZm9ybUJ1ZmZlcihjYW52YXNXaWR0aDogbnVtYmVyLCBjYW52YXNIZWlnaHQ6IG51bWJlcikge1xuICAgIGNvbnN0IG5vdyA9IChwZXJmb3JtYW5jZS5ub3coKSAtIHRoaXMuI3N0YXJ0VGltZSkgLyAxMDAwLjA7XG5cbiAgICBjb25zdCB1Ym86IFVuaWZvcm1CdWZmZXJPYmplY3QgPSB7XG4gICAgICBtb2RlbDogbWF0NC5jcmVhdGUoKSxcbiAgICAgIHZpZXc6IG1hdDQuY3JlYXRlKCksXG4gICAgICBwcm9qOiBtYXQ0LmNyZWF0ZSgpLFxuICAgIH07XG5cbiAgICBtYXQ0LmZyb21aUm90YXRpb24odWJvLm1vZGVsLCAtKG5vdyAqIDkwICogTWF0aC5QSSkgLyAxODApO1xuXG4gICAgY29uc3QgZXllID0gdmVjMy5mcm9tVmFsdWVzKDIsIDIsIDIpO1xuICAgIGNvbnN0IGNlbnRlciA9IHZlYzMuZnJvbVZhbHVlcygwLCAwLCAwKTtcbiAgICBjb25zdCB1cCA9IHZlYzMuZnJvbVZhbHVlcygwLCAwLCAxKTtcbiAgICBtYXQ0Lmxvb2tBdCh1Ym8udmlldywgZXllLCBjZW50ZXIsIHVwKTtcblxuICAgIGNvbnN0IGFzcGVjdCA9IGNhbnZhc1dpZHRoIC8gY2FudmFzSGVpZ2h0O1xuICAgIG1hdDQucGVyc3BlY3RpdmUodWJvLnByb2osIE1hdGguUEkgLyA0LCBhc3BlY3QsIDAuMSwgMTApO1xuXG4gICAgdGhpcy4jZGV2aWNlLnF1ZXVlLndyaXRlQnVmZmVyKHRoaXMuI3Vib0J1ZmZlciwgMCwgZmxhdHRlblVCTyh1Ym8pKTtcbiAgfVxuXG4gIHJlY29yZENvbW1hbmRzKGVuY29kZXI6IEdQVUNvbW1hbmRFbmNvZGVyLCB2aWV3OiBHUFVUZXh0dXJlVmlldywgY2FudmFzV2lkdGg6IG51bWJlciwgY2FudmFzSGVpZ2h0OiBudW1iZXIpIHtcbiAgICBjb25zdCBwYXNzRW5jb2RlciA9IGVuY29kZXIuYmVnaW5SZW5kZXJQYXNzKHtcbiAgICAgIGNvbG9yQXR0YWNobWVudHM6IFt7XG4gICAgICAgIHZpZXcsXG4gICAgICAgIGxvYWRPcDogJ2NsZWFyJyxcbiAgICAgICAgc3RvcmVPcDogJ3N0b3JlJyxcbiAgICAgICAgY2xlYXJWYWx1ZTogQ0xFQVJfQ09MT1IsXG4gICAgICB9XSxcbiAgICB9KTtcblxuICAgIHBhc3NFbmNvZGVyLnNldFBpcGVsaW5lKHRoaXMuI3BpcGVsaW5lKTtcblxuICAgIHBhc3NFbmNvZGVyLnNldFZlcnRleEJ1ZmZlcigwLCB0aGlzLiNjb21iaW5lZEJ1ZmZlci5idWZmZXIsIHRoaXMuI2NvbWJpbmVkQnVmZmVyLnZlcnRleE9mZnNldCk7XG4gICAgcGFzc0VuY29kZXIuc2V0SW5kZXhCdWZmZXIodGhpcy4jY29tYmluZWRCdWZmZXIuYnVmZmVyLCAndWludDE2JywgdGhpcy4jY29tYmluZWRCdWZmZXIuaW5kZXhPZmZzZXQpO1xuXG4gICAgdGhpcy4jdXBkYXRlVW5pZm9ybUJ1ZmZlcihjYW52YXNXaWR0aCwgY2FudmFzSGVpZ2h0KTtcbiAgICBwYXNzRW5jb2Rlci5zZXRCaW5kR3JvdXAoMCwgdGhpcy4jdWJvQmluZEdyb3VwKTtcblxuICAgIHBhc3NFbmNvZGVyLmRyYXdJbmRleGVkKHRoaXMuI2NvbWJpbmVkQnVmZmVyLmluZGV4Q291bnQsIDEsIDAsIDAsIDApO1xuICAgIHBhc3NFbmNvZGVyLmVuZCgpO1xuICB9XG59XG4iXX0=